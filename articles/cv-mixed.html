<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="cv">
<title>Cross-validating mixed-effects models • cv</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cross-validating mixed-effects models">
<meta property="og:description" content="cv">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">cv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/cv.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cv-extend.html">Extending the cv package</a>
    <a class="dropdown-item" href="../articles/cv-mixed.html">Cross-validating mixed-effects models</a>
    <a class="dropdown-item" href="../articles/cv-notes.html">Computational and technical notes on cross-validating regression models</a>
    <a class="dropdown-item" href="../articles/cv-selection.html">Cross-validating model selection</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/gmonette/cv/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Cross-validating mixed-effects models</h1>
                        <h4 data-toc-skip class="author">John Fox and
Georges Monette</h4>
            
            <h4 data-toc-skip class="date">2024-04-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/gmonette/cv/blob/HEAD/vignettes/cv-mixed.Rmd" class="external-link"><code>vignettes/cv-mixed.Rmd</code></a></small>
      <div class="d-none name"><code>cv-mixed.Rmd</code></div>
    </div>

    
    
<p>The fundamental analogy for cross-validation is to the collection of
new data. That is, predicting the response in each fold from the model
fit to data in the other folds is like using the model fit to all of the
data to predict the response for new cases from the values of the
predictors for those new cases. As we explained in the introductory
vignette on cross-validating regression models, the application of this
idea to independently sampled cases is straightforward—simply partition
the data into random folds of equal size and leave each fold out in
turn, or, in the case of LOO CV, simply omit each case in turn.</p>
<p>In contrast, mixed-effects models are fit to <em>dependent</em> data,
in which cases as clustered, such as hierarchical data, where the
clusters comprise higher-level units (e.g., students clustered in
schools), or longitudinal data, where the clusters are individuals and
the cases repeated observations on the individuals over time.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;There are, however, more complex situations that give
rise to so-called &lt;em&gt;crossed&lt;/em&gt; (rather than &lt;em&gt;nested&lt;/em&gt;) random
effects. For example, consider students within classes within schools.
In primary schools, students typically are in a single class, and so
classes are nested within schools. In secondary schools, however,
students typically take several classes and students who are together in
a particular class may not be together in other classes; consequently,
random effects based on classes within schools are crossed. The
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link"&gt;lmer()&lt;/a&gt;&lt;/code&gt; function in the &lt;strong&gt;lme4&lt;/strong&gt; package is
capable of modeling both nested and crossed random effects, and the
&lt;code&gt;&lt;a href="../reference/cv.html"&gt;cv()&lt;/a&gt;&lt;/code&gt; methods for mixed models in the &lt;strong&gt;cv&lt;/strong&gt;
package pertain to both nested and crossed random effects. We present an
example of the latter later in the vignette.&lt;/p&gt;'><sup>1</sup></a></p>
<p>We can think of two approaches to applying cross-validation to
clustered data:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;We subsequently discovered that &lt;span class="citation"&gt;Vehtari (2023, sec. 8)&lt;/span&gt; makes similar points.&lt;/p&gt;'><sup>2</sup></a></p>
<ol style="list-style-type: decimal">
<li><p>Treat CV as analogous to predicting the response for one or more
cases in a <em>newly observed cluster</em>. In this instance, the folds
comprise one or more whole clusters; we refit the model with all of the
cases in clusters in the current fold removed; and then we predict the
response for the cases in clusters in the current fold. These
predictions are based only on fixed effects because the random effects
for the omitted clusters are presumably unknown, as they would be for
data on cases in newly observed clusters.</p></li>
<li><p>Treat CV as analogous to predicting the response for a newly
observed case in an <em>existing cluster</em>. In this instance, the
folds comprise one or more individual cases, and the predictions can use
both the fixed and random effects.</p></li>
</ol>
<div class="section level2">
<h2 id="example-the-high-school-and-beyond-data">Example: The High-School and Beyond data<a class="anchor" aria-label="anchor" href="#example-the-high-school-and-beyond-data"></a>
</h2>
<p>Following their use by <span class="citation">Raudenbush &amp; Bryk
(2002)</span>, data from the 1982 <em>High School and Beyond</em> (HSB)
survey have become a staple of the literature on mixed-effects models.
The HSB data are used by <span class="citation">Fox &amp; Weisberg
(2019, sec. 7.2.2)</span> to illustrate the application of linear mixed
models to hierarchical data, and we’ll closely follow their example
here.</p>
<p>The HSB data are included in the <code>MathAchieve</code> and
<code>MathAchSchool</code> data sets in the <strong>nlme</strong>
package <span class="citation">(Pinheiro &amp; Bates, 2000)</span>.
<code>MathAchieve</code> includes individual-level data on 7185 students
in 160 high schools, and <code>MathAchSchool</code> includes
school-level data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"MathAchieve"</span>, package <span class="op">=</span> <span class="st">"nlme"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">MathAchieve</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7185    6</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">MathAchieve</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   School Minority    Sex    SES MathAch MEANSES</span></span>
<span><span class="co">#&gt; 1   1224       No Female -1.528   5.876  -0.428</span></span>
<span><span class="co">#&gt; 2   1224       No Female -0.588  19.708  -0.428</span></span>
<span><span class="co">#&gt; 3   1224       No   Male -0.528  20.349  -0.428</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">MathAchieve</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;      School Minority    Sex    SES MathAch MEANSES</span></span>
<span><span class="co">#&gt; 7183   9586       No Female  1.332  19.641   0.627</span></span>
<span><span class="co">#&gt; 7184   9586       No Female -0.008  16.241   0.627</span></span>
<span><span class="co">#&gt; 7185   9586       No Female  0.792  22.733   0.627</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"MathAchSchool"</span>, package <span class="op">=</span> <span class="st">"nlme"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">MathAchSchool</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 160   7</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">MathAchSchool</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;      School Size Sector PRACAD DISCLIM HIMINTY MEANSES</span></span>
<span><span class="co">#&gt; 1224   1224  842 Public   0.35   1.597       0  -0.428</span></span>
<span><span class="co">#&gt; 1288   1288 1855 Public   0.27   0.174       0   0.128</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">MathAchSchool</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;      School Size   Sector PRACAD DISCLIM HIMINTY MEANSES</span></span>
<span><span class="co">#&gt; 9550   9550 1532   Public   0.45   0.791       0   0.059</span></span>
<span><span class="co">#&gt; 9586   9586  262 Catholic   1.00  -2.416       0   0.627</span></span></code></pre></div>
<p>The first few students are in school number 1224 and the last few in
school 9586.</p>
<p>We’ll use only the <code>School</code>, <code>SES</code> (students’
socioeconomic status), and <code>MathAch</code> (their score on a
standardized math-achievement test) variables in the
<code>MathAchieve</code> data set, and <code>Sector</code>
(<code>"Catholic"</code> or <code>"Public"</code>) in the
<code>MathAchSchool</code> data set.</p>
<p>Some data-management is required before fitting a mixed-effects model
to the HSB data, for which we use the <strong>dplyr</strong> package
<span class="citation">(Wickham, François, Henry, Müller, &amp; Vaughan,
2023)</span>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span><span class="op">)</span></span>
<span><span class="va">MathAchieve</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">School</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mean.ses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">SES</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">Temp</span></span>
<span><span class="va">Temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">MathAchSchool</span>, <span class="va">Temp</span>, by <span class="op">=</span> <span class="st">"School"</span><span class="op">)</span></span>
<span><span class="va">HSB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">Temp</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"School"</span>, <span class="st">"Sector"</span>, <span class="st">"mean.ses"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>             <span class="va">MathAchieve</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"School"</span>, <span class="st">"SES"</span>, <span class="st">"MathAch"</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="st">"School"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">HSB</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">HSB</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">HSB</span><span class="op">$</span><span class="va">cses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">HSB</span>, <span class="va">ses</span> <span class="op">-</span> <span class="va">mean.ses</span><span class="op">)</span></span></code></pre></div>
<p>In the process, we created two new school-level variables:
<code>meanses</code>, which is the average SES for students in each
school; and <code>cses</code>, which is school-average SES centered at
its mean. For details, see <span class="citation">Fox &amp; Weisberg
(2019, sec. 7.2.2)</span>.</p>
<p>Still following Fox and Weisberg, we proceed to use the
<code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> function in the <strong>lme4</strong> package <span class="citation">(Bates, Mächler, Bolker, &amp; Walker, 2015)</span> to
fit a mixed model for math achievement to the HSB data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/lme4/lme4/" class="external-link">"lme4"</a></span><span class="op">)</span></span>
<span><span class="va">hsb.lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">mathach</span> <span class="op">~</span> <span class="va">mean.ses</span> <span class="op">*</span> <span class="va">cses</span> <span class="op">+</span> <span class="va">sector</span> <span class="op">*</span> <span class="va">cses</span></span>
<span>                 <span class="op">+</span> <span class="op">(</span><span class="va">cses</span> <span class="op">|</span> <span class="va">school</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">HSB</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hsb.lmer</span>, correlation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: mathach ~ mean.ses * cses + sector * cses + (cses | school)</span></span>
<span><span class="co">#&gt;    Data: HSB</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 46504</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt; -3.159 -0.723  0.017  0.754  2.958 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev. Corr</span></span>
<span><span class="co">#&gt;  school   (Intercept)  2.380   1.543        </span></span>
<span><span class="co">#&gt;           cses         0.101   0.318    0.39</span></span>
<span><span class="co">#&gt;  Residual             36.721   6.060        </span></span>
<span><span class="co">#&gt; Number of obs: 7185, groups:  school, 160</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;                     Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)           12.128      0.199   60.86</span></span>
<span><span class="co">#&gt; mean.ses               5.333      0.369   14.45</span></span>
<span><span class="co">#&gt; cses                   2.945      0.156   18.93</span></span>
<span><span class="co">#&gt; sectorCatholic         1.227      0.306    4.00</span></span>
<span><span class="co">#&gt; mean.ses:cses          1.039      0.299    3.48</span></span>
<span><span class="co">#&gt; cses:sectorCatholic   -1.643      0.240   -6.85</span></span></code></pre></div>
<p>We can then cross-validate at the cluster (i.e., school) level,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://gmonette.github.io/cv/">"cv"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lmer</span>,</span>
<span>   k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>   clusterVariables <span class="op">=</span> <span class="st">"school"</span>,</span>
<span>   seed <span class="op">=</span> <span class="fl">5240</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 5240</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation based on 160 {school} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 39.157</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 39.148</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (38.066, 40.231)</span></span>
<span><span class="co">#&gt; full-sample criterion = 39.006</span></span></code></pre></div>
<p>or at the case (i.e., student) level,</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lmer</span>, seed <span class="op">=</span> <span class="fl">1575</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 1575</span></span>
<span><span class="co">#&gt; Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :</span></span>
<span><span class="co">#&gt; Model failed to converge with max|grad| = 0.0058701 (tol = 0.002, component 1)</span></span>
<span><span class="co">#&gt; boundary (singular) fit: see help('isSingular')</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 37.445</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 37.338</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (36.288, 38.388)</span></span>
<span><span class="co">#&gt; full-sample criterion = 36.068</span></span></code></pre></div>
<p>For cluster-level CV, the <code>clusterVariables</code> argument
tells <code><a href="../reference/cv.html">cv()</a></code> how the clusters are defined. Were there more
than one clustering variable, say classes within schools, these would be
provided as a character vector of variable names:
<code>clusterVariables = c("school", "class")</code>. For cluster-level
CV, the default is <code>k = "loo"</code>, that is, leave one cluster
out at a time; we instead specify <code>k = 10</code> folds of clusters,
each fold therefore comprising <span class="math inline">\(160/10 =
16\)</span> schools.</p>
<p>If the <code>clusterVariables</code> argument is omitted, then
case-level CV is employed, with <code>k = 10</code> folds as the
default, here each with <span class="math inline">\(7185/10 \approx
719\)</span> students. Notice that one of the 10 models refit with a
fold removed failed to converge. Convergence problems are common in
mixed-effects modeling. The apparent issue here is that an estimated
variance component is close to or equal to 0, which is at a boundary of
the parameter space. That shouldn’t disqualify the fitted model for the
kind of prediction required for cross-validation.</p>
<p>There is also a <code><a href="../reference/cv.html">cv()</a></code> method for linear mixed models fit
by the <code><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme()</a></code> function in the <strong>nlme</strong> package,
and the arguments for <code><a href="../reference/cv.html">cv()</a></code> in this case are the same as for
a model fit by <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> or <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html" class="external-link">glmer()</a></code>. We
illustrate with the mixed model fit to the HSB data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://svn.r-project.org/R-packages/trunk/nlme/" class="external-link">"nlme"</a></span><span class="op">)</span></span>
<span><span class="va">hsb.lme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme</a></span><span class="op">(</span></span>
<span>  <span class="va">mathach</span> <span class="op">~</span> <span class="va">mean.ses</span> <span class="op">*</span> <span class="va">cses</span> <span class="op">+</span> <span class="va">sector</span> <span class="op">*</span> <span class="va">cses</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span> <span class="va">cses</span> <span class="op">|</span> <span class="va">school</span>,</span>
<span>  data <span class="op">=</span> <span class="va">HSB</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>opt <span class="op">=</span> <span class="st">"optim"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hsb.lme</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed-effects model fit by REML</span></span>
<span><span class="co">#&gt;   Data: HSB </span></span>
<span><span class="co">#&gt;     AIC   BIC logLik</span></span>
<span><span class="co">#&gt;   46525 46594 -23252</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Formula: ~cses | school</span></span>
<span><span class="co">#&gt;  Structure: General positive-definite, Log-Cholesky parametrization</span></span>
<span><span class="co">#&gt;             StdDev   Corr  </span></span>
<span><span class="co">#&gt; (Intercept) 1.541177 (Intr)</span></span>
<span><span class="co">#&gt; cses        0.018174 0.006 </span></span>
<span><span class="co">#&gt; Residual    6.063492       </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:  mathach ~ mean.ses * cses + sector * cses </span></span>
<span><span class="co">#&gt;                       Value Std.Error   DF t-value p-value</span></span>
<span><span class="co">#&gt; (Intercept)         12.1282   0.19920 7022  60.886   0e+00</span></span>
<span><span class="co">#&gt; mean.ses             5.3367   0.36898  157  14.463   0e+00</span></span>
<span><span class="co">#&gt; cses                 2.9421   0.15122 7022  19.456   0e+00</span></span>
<span><span class="co">#&gt; sectorCatholic       1.2245   0.30611  157   4.000   1e-04</span></span>
<span><span class="co">#&gt; mean.ses:cses        1.0444   0.29107 7022   3.588   3e-04</span></span>
<span><span class="co">#&gt; cses:sectorCatholic -1.6421   0.23312 7022  -7.044   0e+00</span></span>
<span><span class="co">#&gt;  Correlation: </span></span>
<span><span class="co">#&gt;                     (Intr) men.ss cses   sctrCt mn.ss:</span></span>
<span><span class="co">#&gt; mean.ses             0.256                            </span></span>
<span><span class="co">#&gt; cses                 0.000  0.000                     </span></span>
<span><span class="co">#&gt; sectorCatholic      -0.699 -0.356  0.000              </span></span>
<span><span class="co">#&gt; mean.ses:cses        0.000  0.000  0.295  0.000       </span></span>
<span><span class="co">#&gt; cses:sectorCatholic  0.000  0.000 -0.696  0.000 -0.351</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Standardized Within-Group Residuals:</span></span>
<span><span class="co">#&gt;       Min        Q1       Med        Q3       Max </span></span>
<span><span class="co">#&gt; -3.170106 -0.724877  0.014892  0.754263  2.965498 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of Observations: 7185</span></span>
<span><span class="co">#&gt; Number of Groups: 160</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lme</span>,</span>
<span>   k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>   clusterVariables <span class="op">=</span> <span class="st">"school"</span>,</span>
<span>   seed <span class="op">=</span> <span class="fl">5240</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 5240</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation based on 160 {school} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 39.157</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 39.149</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (38.066, 40.232)</span></span>
<span><span class="co">#&gt; full-sample criterion = 39.006</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lme</span>, seed <span class="op">=</span> <span class="fl">1575</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 1575</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 37.442</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 37.402</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (36.351, 38.453)</span></span>
<span><span class="co">#&gt; full-sample criterion = 36.147</span></span></code></pre></div>
<p>We used the same random-number generator seeds as in the previous
example cross-validating the model fit by <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code>, and so
the same folds are employed in both cases.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The observant reader will notice that we set the
argument &lt;code&gt;control=list(opt="optim")&lt;/code&gt; in the call to
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt;, changing the optimizer employed from the default
&lt;code&gt;"nlminb"&lt;/code&gt;. We did this because with the default optimizer,
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt; encountered the same convergence issue as
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link"&gt;lmer()&lt;/a&gt;&lt;/code&gt;, but rather than issuing a warning,
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt; failed, reporting an error. As it turns out, setting
the optimizer to &lt;code&gt;"optim"&lt;/code&gt; avoids this problem.&lt;/p&gt;'><sup>3</sup></a> The estimated
covariance components and fixed effects in the summary output differ
slightly between the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> and <code><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme()</a></code>
solutions, although both functions seek to maximize the REML criterion.
This is, of course, to be expected when different algorithms are used
for numerical optimization. To the precision reported, the cluster-level
CV results for the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> and <code><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme()</a></code> models are
identical, while the case-level CV results are very similar but not
identical.</p>
</div>
<div class="section level2">
<h2 id="example-contrived-hierarchical-data">Example: Contrived hierarchical data<a class="anchor" aria-label="anchor" href="#example-contrived-hierarchical-data"></a>
</h2>
<p>We introduce an artificial data set that exemplifies aspects of
cross-validation particular to hierarchical models. Using this data set,
we show that model comparisons employing cluster-based and those
employing case-based cross-validation may not agree on a “best” model.
Furthermore, commonly used measures of fit, such as mean-squared error,
do not necessarily become smaller as models become larger, even when the
models are nested, and even when the measure of fit is computed for the
whole data set.</p>
<p>Consider a researcher studying improvement in a skill, yodeling, for
example, among students enrolled in a four-year yodeling program. The
plan is to measure each student’s skill level at the beginning of the
program and every year thereafter until the end of the program,
resulting in five annual measurements for each student. It turns out
that yodeling appeals to students of all ages, and students enrolling in
the program range in age from 20 to 70. Moreover, participants’
untrained yodeling skill is similar at all ages, as is their rate of
progress with training. All students complete the four-year program.</p>
<p>The researcher, who has more expertise in yodeling than in modeling,
decides to model the response, <span class="math inline">\(y\)</span>,
yodeling skill, as a function of age, <span class="math inline">\(x\)</span>, reasoning that students get older
during their stay in the program, and (incorrectly) that age can serve
as a proxy for elapsed time. The researcher knows that a mixed model
should be used to account for clustering due to the expected similarity
of measurements taken from each student.</p>
<p>We start by generating the data, using parameters consistent with the
description above and meant to highlight the issues that arise in
cross-validating mixed-effects models:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;We invite the interested reader to experiment with
varying the parameters of our example.&lt;/p&gt;"><sup>4</sup></a></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parameters:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">9693</span><span class="op">)</span></span>
<span><span class="va">Nb</span> <span class="op">&lt;-</span> <span class="fl">100</span>     <span class="co"># number of groups</span></span>
<span><span class="va">Nw</span> <span class="op">&lt;-</span> <span class="fl">5</span>       <span class="co"># number of individuals within groups</span></span>
<span><span class="va">Bb</span> <span class="op">&lt;-</span> <span class="fl">0</span>       <span class="co"># between-group regression coefficient on group mean</span></span>
<span><span class="va">SDre</span> <span class="op">&lt;-</span></span>
<span>  <span class="fl">2.0</span>   <span class="co"># between-group SD of random level relative to group mean of x</span></span>
<span><span class="va">SDwithin</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>  <span class="co"># within group SD</span></span>
<span><span class="va">Bw</span> <span class="op">&lt;-</span> <span class="fl">1</span>          <span class="co"># within group effect of x</span></span>
<span><span class="va">Ay</span> <span class="op">&lt;-</span> <span class="fl">10</span>         <span class="co"># intercept for response</span></span>
<span><span class="va">Ax</span> <span class="op">&lt;-</span> <span class="fl">20</span>         <span class="co"># starting level of x</span></span>
<span><span class="va">Nx</span> <span class="op">&lt;-</span> <span class="va">Nw</span> <span class="op">*</span> <span class="fl">10</span>    <span class="co"># number of distinct x values</span></span>
<span></span>
<span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Nb</span>, each <span class="op">=</span> <span class="va">Nw</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   x <span class="op">=</span> <span class="va">Ax</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Nx</span>, length.out <span class="op">=</span> <span class="va">Nw</span> <span class="op">*</span> <span class="va">Nb</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">xm</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html" class="external-link">ave</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">group</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> <span class="co"># within-group mean</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">Ay</span> <span class="op">+</span></span>
<span>      <span class="va">Bb</span> <span class="op">*</span> <span class="va">xm</span> <span class="op">+</span>                      <span class="co"># contextual effect</span></span>
<span>      <span class="va">Bw</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">xm</span><span class="op">)</span> <span class="op">+</span>                <span class="co"># within-group effect</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">Nb</span>, sd <span class="op">=</span> <span class="va">SDre</span><span class="op">)</span><span class="op">[</span><span class="va">group</span><span class="op">]</span> <span class="op">+</span>  <span class="co"># random level by group</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">Nb</span> <span class="op">*</span> <span class="va">Nw</span>, sd <span class="op">=</span> <span class="va">SDwithin</span><span class="op">)</span>  <span class="co"># random error within groups</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Here is a scatterplot of the data for a representative group of 10
(without loss of generality, the first 10) of 100 students, showing the
95% concentration ellipse for each cluster:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;We find it convenient to use the
&lt;strong&gt;lattice&lt;/strong&gt; &lt;span class="citation"&gt;(Sarkar, 2008)&lt;/span&gt;
and &lt;strong&gt;latticeExtra&lt;/strong&gt; &lt;span class="citation"&gt;(Sarkar &amp;amp;
Andrews, 2022)&lt;/span&gt; packages for this and other graphs in this
section.&lt;/p&gt;'><sup>5</sup></a></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://lattice.r-forge.r-project.org/" class="external-link">"lattice"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://latticeextra.r-forge.r-project.org/" class="external-link">"latticeExtra"</a></span><span class="op">)</span></span>
<span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>  data <span class="op">=</span> <span class="va">Data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Nx</span>,<span class="op">]</span>,</span>
<span>  group <span class="op">=</span> <span class="va">group</span>,</span>
<span>  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>  par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>superpose.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pch <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span></span>
<span>                                                <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/layer.html" class="external-link">layer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/panel.ellipse.html" class="external-link">panel.ellipse</a></span><span class="op">(</span><span class="va">...</span>, center.cex <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plot</span> <span class="co"># display graph</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/plot1-1.png" alt="Hierarchical data set, showing the first 10 of 100 students." width="100%"><p class="caption">
Hierarchical data set, showing the first 10 of 100 students.
</p>
</div>
<p>The between-student effect of age is 0 but the within-student effect
is 1. Due to the large variation in ages between students, the
least-squares regression of yodeling skill on age (for the 500
observations among all 100 students) produces an estimated slope close
to 0 (though with a small <span class="math inline">\(p\)</span>-value),
because the slope is heavily weighted toward the between-student
effect:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data<span class="op">=</span><span class="va">Data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = y ~ x, data = Data)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt; -5.771 -1.658 -0.089  1.552  7.624 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  9.05043    0.34719   26.07   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; x            0.02091    0.00727    2.87   0.0042 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 2.35 on 498 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.0163, Adjusted R-squared:  0.0143 </span></span>
<span><span class="co">#&gt; F-statistic: 8.26 on 1 and 498 DF,  p-value: 0.00422</span></span></code></pre></div>
<p>The initial mixed-effects model that we fit to the data is a simple
random-intercepts model:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># random intercept only:</span></span>
<span><span class="va">mod.0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>, <span class="va">Data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod.0</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: y ~ 1 + (1 | group)</span></span>
<span><span class="co">#&gt;    Data: Data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 2103.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.0351 -0.7264 -0.0117  0.7848  2.0438 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  group    (Intercept) 2.90     1.70    </span></span>
<span><span class="co">#&gt;  Residual             2.71     1.65    </span></span>
<span><span class="co">#&gt; Number of obs: 500, groups:  group, 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)   10.002      0.186    53.9</span></span></code></pre></div>
<p>We will shortly consider three other, more complex, mixed models;
because of data-management considerations, it is convenient to fit them
now, but we defer discussion of these models:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># effect of x and random intercept:</span></span>
<span><span class="va">mod.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>, <span class="va">Data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># effect of x, contextual (student) mean of x, and random intercept:</span></span>
<span><span class="va">mod.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">xm</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>, <span class="va">Data</span><span class="op">)</span></span>
<span>        <span class="co"># equivalent to y ~ I(x - xm) + xm + (1 | group)</span></span>
<span></span>
<span><span class="co"># model generating the data (where Bb = 0)</span></span>
<span><span class="va">mod.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">xm</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">group</span><span class="op">)</span>, <span class="va">Data</span><span class="op">)</span></span></code></pre></div>
<p>We proceed to obtain predictions from the random-intercept model
(<code>mod.0</code>) and the other models (<code>mod.1</code>,
<code>mod.2</code>, and <code>mod.3</code>) based on fixed effects
alone, as would be used for cross-validation based on clusters (i.e.,
students), and for fixed and random effects—so-called best linear
unbiased predictions or BLUPs—as would be used for cross-validation
based on cases (i.e., occasions within students):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="va">Data</span>, <span class="op">{</span></span>
<span>  <span class="va">fit_mod0.fe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.0</span>, re.form <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># fixed effects only</span></span>
<span>  <span class="va">fit_mod0.re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.0</span><span class="op">)</span> <span class="co"># fixed and random effects (BLUPs)</span></span>
<span>  <span class="va">fit_mod1.fe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.1</span>, re.form <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">fit_mod1.re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.1</span><span class="op">)</span></span>
<span>  <span class="va">fit_mod2.fe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.2</span>, re.form <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">fit_mod2.re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.2</span><span class="op">)</span></span>
<span>  <span class="va">fit_mod3.fe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.3</span>, re.form <span class="op">=</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">fit_mod3.re</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod.3</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We then prepare the data for plotting:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Data_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html" class="external-link">reshape</a></span><span class="op">(</span><span class="va">Data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Nx</span>, <span class="op">]</span>, direction <span class="op">=</span> <span class="st">"long"</span>, sep <span class="op">=</span> <span class="st">"."</span>, </span>
<span>              timevar <span class="op">=</span> <span class="st">"effect"</span>, varying <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Data</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">Nx</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Data_long</span><span class="op">$</span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Data_long</span><span class="op">)</span></span>
<span><span class="va">Data_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/reshape.html" class="external-link">reshape</a></span><span class="op">(</span><span class="va">Data_long</span>, direction <span class="op">=</span> <span class="st">"long"</span>, sep <span class="op">=</span> <span class="st">"_"</span>, </span>
<span>              timevar <span class="op">=</span> <span class="st">"modelcode"</span>,  varying <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Data_long</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Data_long</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"~ 1"</span>, <span class="st">"~ 1 + x"</span>, <span class="st">"~ 1 + x + xm"</span>, <span class="st">"~ 1 + I(x - xm)"</span><span class="op">)</span></span>
<span>  <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">Data_long</span><span class="op">$</span><span class="va">modelcode</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mod0"</span>, <span class="st">"mod1"</span>, <span class="st">"mod2"</span>, <span class="st">"mod3"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Predictions based on the random-intercept model <code>mod.0</code>
for the first 10 students are shown in the following graph:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">plot</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod0"</span> <span class="op">&amp;</span> <span class="va">effect</span> <span class="op">==</span> <span class="st">"fe"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod0"</span> <span class="op">&amp;</span>  <span class="va">effect</span> <span class="op">==</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      lty <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  main<span class="op">=</span><span class="st">"Model: y ~ 1 + (1 | group)"</span>,</span>
<span>  key<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    corner<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fixed effects only"</span>,<span class="st">"fixed and random"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    lines<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/plot-fits-mod0-1.png" alt="Predictions from the random intercept model." width="100%"><p class="caption">
Predictions from the random intercept model.
</p>
</div>
<p>The fixed-effect predictions for the various individuals are
identical—the estimated fixed-effects intercept or estimated general
mean of <span class="math inline">\(y\)</span>—while the BLUPs are the
sums of the fixed-effects intercept and the random intercepts, and are
only slightly shrunken towards the general mean. Because in our
artificial data there is no population relationship between age and
skill, the fixed-effect-only predictions and the BLUPs are not very
different.</p>
<p>Our next model, <code>mod.1</code>, includes a fixed intercept and
fixed effect of <code>x</code> along with a random intercept:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: y ~ x + (1 | group)</span></span>
<span><span class="co">#&gt;    Data: Data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 1564.5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.9016 -0.6350  0.0188  0.5541  2.8293 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  group    (Intercept) 192.941  13.890  </span></span>
<span><span class="co">#&gt;  Residual               0.257   0.507  </span></span>
<span><span class="co">#&gt; Number of obs: 500, groups:  group, 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept) -33.9189     1.5645   -21.7</span></span>
<span><span class="co">#&gt; x             0.9653     0.0158    61.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correlation of Fixed Effects:</span></span>
<span><span class="co">#&gt;   (Intr)</span></span>
<span><span class="co">#&gt; x -0.460</span></span></code></pre></div>
<p>Predictions from this model appear in the following graph:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">plot</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod1"</span> <span class="op">&amp;</span> <span class="va">effect</span> <span class="op">==</span> <span class="st">"fe"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod1"</span> <span class="op">&amp;</span> <span class="va">effect</span> <span class="op">==</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      lty <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  main<span class="op">=</span><span class="st">"Model: y ~ 1 + x + (1 | group)"</span>,</span>
<span>  ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">35</span><span class="op">)</span>,</span>
<span>  key<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    corner<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fixed effects only"</span>,<span class="st">"fixed and random"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    lines<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/plot-fits-mod1-1.png" alt="Predictions from the model with random intercepts and $x$ as a fixed-effect predictor." width="100%"><p class="caption">
Predictions from the model with random intercepts and <span class="math inline">\(x\)</span> as a fixed-effect predictor.
</p>
</div>
<p>The BLUPs fit the observed data very closely, but predictions based
on the fixed effects alone, with a common intercept and slope for all
clusters, are very poor—indeed, much worse than the fixed-effects-only
predictions based on the simpler random-intercept model,
<code>mod.0</code>. We therefore anticipate (and show later in this
section) that case-based cross-validation will prefer <code>mod1</code>
to <code>mod0</code>, but that cluster-based cross-validation will
prefer <code>mod0</code> to <code>mod1</code>.</p>
<p>Our third model, <code>mod.2</code>, includes the contextual effect
of <span class="math inline">\(x\)</span>—that is, the cluster mean
<code>xm</code>—along with <span class="math inline">\(x\)</span> and
the intercept in the fixed-effect part of the model, and a random
intercept:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod.2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: y ~ x + xm + (1 | group)</span></span>
<span><span class="co">#&gt;    Data: Data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 1169.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.9847 -0.6375  0.0019  0.5568  2.7325 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  group    (Intercept) 3.399    1.844   </span></span>
<span><span class="co">#&gt;  Residual             0.255    0.505   </span></span>
<span><span class="co">#&gt; Number of obs: 500, groups:  group, 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)   9.4787     0.6171    15.4</span></span>
<span><span class="co">#&gt; x             0.9915     0.0160    62.1</span></span>
<span><span class="co">#&gt; xm           -0.9800     0.0206   -47.7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correlation of Fixed Effects:</span></span>
<span><span class="co">#&gt;    (Intr) x     </span></span>
<span><span class="co">#&gt; x   0.000       </span></span>
<span><span class="co">#&gt; xm -0.600 -0.777</span></span></code></pre></div>
<p>This model is equivalent to fitting
<code>y ~ I(x - xm) + xm + (1 | group)</code>, which is the model that
generated the data once the coefficient of the contextual predictor
<code>xm</code> is set to 0 (as it is in <code>mod.3</code>, discussed
below).</p>
<p>Predictions from model <code>mod.2</code> appear in the following
graph:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">plot</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod2"</span> <span class="op">&amp;</span> <span class="va">effect</span> <span class="op">==</span> <span class="st">"fe"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod2"</span> <span class="op">&amp;</span> <span class="va">effect</span> <span class="op">==</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      lty <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  main<span class="op">=</span><span class="st">"Model: y ~ 1 + x + xm + (1 | group)"</span>,</span>
<span>  ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>  key<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    corner<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fixed effects only"</span>,<span class="st">"fixed and random"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    lines<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/plot-fits-mod2-1.png" alt="Predictors from the model with random intercepts, $x$, and the group (student) mean of $x$ as predictors." width="100%"><p class="caption">
Predictors from the model with random intercepts, <span class="math inline">\(x\)</span>, and the group (student) mean of <span class="math inline">\(x\)</span> as predictors.
</p>
</div>
<p>Depending on the estimated variance parameters of the model, a mixed
model like <code>mod.2</code> will apply varying degrees of shrinkage to
the random-intercept BLUPs that correspond to variation in the heights
of the parallel fitted lines for the individual students. In our
contrived data, the <code>mod.2</code> applies little shrinkage,
allowing substantial variability in the heights of the fitted lines,
which closely approach the observed values for each student. The fit of
the mixed model <code>mod.2</code> is consequently similar to that of a
fixed-effects model with age and a categorical predictor for individual
students (i.e., treating students as a factor, and not shown here).</p>
<p>The mixed model <code>mod.2</code> therefore fits individual
observations well, and we anticipate a favorable assessment using
individual-based cross-validation. In contrast, the large variability in
the BLUPs results in larger residuals for predictions based on fixed
effects alone, and so we expect that cluster-based cross-validation
won’t show an advantage for model <code>mod.2</code> compared to the
smaller model <code>mod.0</code>, which includes only fixed and random
intercepts.</p>
<p>Had the mixed model applied considerable shrinkage, then neither
cluster-based nor case-based cross-validation would show much
improvement over the random-intercept-only model. In our experience, the
degree of shrinkage does not vary smoothly as parameters are changed but
tends to be “all or nothing,” and near the tipping point, the behavior
of estimates can be affected considerably by the choice of algorithm
used to fit the model.</p>
<p>Finally, <code>mod.3</code> directly estimates the model used to
generate the data. As mentioned, it is a constrained version of
<code>mod.2</code>, with the coefficient of <code>xm</code> set to 0,
and with <code>x</code> expressed as a deviation from the cluster mean
<code>xm</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod.3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: y ~ I(x - xm) + (1 | group)</span></span>
<span><span class="co">#&gt;    Data: Data</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 1163.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.9770 -0.6320  0.0063  0.5603  2.7249 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  group    (Intercept) 3.391    1.842   </span></span>
<span><span class="co">#&gt;  Residual             0.255    0.505   </span></span>
<span><span class="co">#&gt; Number of obs: 500, groups:  group, 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)   10.002      0.185    53.9</span></span>
<span><span class="co">#&gt; I(x - xm)      0.992      0.016    62.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correlation of Fixed Effects:</span></span>
<span><span class="co">#&gt;           (Intr)</span></span>
<span><span class="co">#&gt; I(x - xm) 0.000</span></span></code></pre></div>
<p>The predictions from <code>mod.3</code> are therefore similar to
those from <code>mod.2</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span></span>
<span>  <span class="va">plot</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod3"</span> <span class="op">&amp;</span> <span class="va">effect</span> <span class="op">==</span> <span class="st">"fe"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>      <span class="va">fit</span> <span class="op">~</span> <span class="va">x</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Data_long</span>, <span class="va">modelcode</span> <span class="op">==</span> <span class="st">"mod3"</span> <span class="op">&amp;</span> <span class="va">effect</span> <span class="op">==</span> <span class="st">"re"</span><span class="op">)</span>,</span>
<span>      groups <span class="op">=</span> <span class="va">group</span>,</span>
<span>      type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>      lwd <span class="op">=</span> <span class="fl">2</span>,</span>
<span>      lty <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  main<span class="op">=</span><span class="st">"Model: y ~ 1 + I(x - xm) + (1 | group)"</span>,</span>
<span>  ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">16</span><span class="op">)</span>,</span>
<span>  key<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    corner<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fixed effects only"</span>,<span class="st">"fixed and random"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    lines<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lty<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/plot-fits-mod3-1.png" alt="Predictions from the estimated model generating the data." width="100%"><p class="caption">
Predictions from the estimated model generating the data.
</p>
</div>
<p>We next carry out case-based cross-validation, which, as we have
explained, is based on both fixed and predicted random effects (i.e.,
BLUPs), and cluster-based cross-validation, which is based on fixed
effects only. In order to reduce between-model random variability in
comparisons of models, we apply <code><a href="../reference/cv.html">cv()</a></code> to the list of models
created by the <code><a href="../reference/cv.modList.html">models()</a></code> function (introduced previously),
performing cross-validation with the same folds for each model:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv.modList.html">models</a></span><span class="op">(</span></span>
<span>  <span class="st">"~ 1"</span> <span class="op">=</span> <span class="va">mod.0</span>,</span>
<span>  <span class="st">"~ 1 + x"</span> <span class="op">=</span> <span class="va">mod.1</span>,</span>
<span>  <span class="st">"~ 1 + x + xm"</span> <span class="op">=</span> <span class="va">mod.2</span>,</span>
<span>  <span class="st">"~ 1 + I(x - xm)"</span> <span class="op">=</span> <span class="va">mod.3</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cvs_clusters</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span></span>
<span>    <span class="va">modlist</span>,</span>
<span>    data <span class="op">=</span> <span class="va">Data</span>,</span>
<span>    cluster <span class="op">=</span> <span class="st">"group"</span>,</span>
<span>    k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">6449</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cvs_clusters</span>, main <span class="op">=</span> <span class="st">"Model Comparison, Cluster-Based CV"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/cross-validation-clusters-1.png" alt="10-fold cluster-based cross-validation comparing random intercept models with varying fixed effects. The error bars show the 95% confidence interval around the CV estimate of the MSE for each model." width="100%"><p class="caption">
10-fold cluster-based cross-validation comparing random intercept models
with varying fixed effects. The error bars show the 95% confidence
interval around the CV estimate of the MSE for each model.
</p>
</div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cvs_cases</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">modlist</span>, data <span class="op">=</span> <span class="va">Data</span>, seed <span class="op">=</span> <span class="fl">9693</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cvs_cases</span>, main <span class="op">=</span> <span class="st">"Model Comparison, Case-Based CV"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/cross-validation-cases-1.png" alt="10-fold case-based cross-validation comparing random intercept models with varying fixed effects." width="100%"><p class="caption">
10-fold case-based cross-validation comparing random intercept models
with varying fixed effects.
</p>
</div>
<p>In summary, model <code>mod.1</code>, with <span class="math inline">\(x\)</span> alone and without the contextual mean
of <span class="math inline">\(x\)</span>, is assessed as fitting very
poorly by cluster-based CV, but relatively much better by case-based CV.
Model <code>mod.2</code>, which includes both <span class="math inline">\(x\)</span> and its contextual mean, produces
better results using both cluster-based and case-based CV. The
data-generating model, <code>mod.3</code>, which includes the fixed
effect of <code>x - xm</code> in place of separate terms in
<code>x</code> and <code>xm</code>, isn’t distinguishable from model
<code>mod.2</code>, which includes <code>x</code> and <code>xm</code>
separately, even though <code>mod.2</code> has an unnecessary parameter
(recall that the population coefficient of <code>xm</code> is 0 when
<code>x</code> is expressed as deviations from the contextual mean).
These conclusions are consistent with our observations based on graphing
predictions from the various models, and they illustrate the
desirability of assessing mixed-effect models at different hierarchical
levels.</p>
</div>
<div class="section level2">
<h2 id="example-crossed-random-effects">Example: Crossed random effects<a class="anchor" aria-label="anchor" href="#example-crossed-random-effects"></a>
</h2>
<p>Crossed random effects arise when the structure of the data aren’t
strictly hierarchical. Nevertheless, crossed and nested random effects
can be handled in much the same manner, by refitting the mixed-effects
model to the data with a fold of clusters or cases removed and using the
refitted model to predict the response in the removed fold.</p>
<p>We’ll illustrate with data on pig growth, introduced by <span class="citation">Diggle, Liang, &amp; Zeger (1994, Table 3.1)</span>.
The data are in the <code>Pigs</code> data frame in the
<strong>cv</strong> package:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Pigs</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id week weight</span></span>
<span><span class="co">#&gt; 1  1    1   24.0</span></span>
<span><span class="co">#&gt; 2  1    2   32.0</span></span>
<span><span class="co">#&gt; 3  1    3   39.0</span></span>
<span><span class="co">#&gt; 4  1    4   42.5</span></span>
<span><span class="co">#&gt; 5  1    5   48.0</span></span>
<span><span class="co">#&gt; 6  1    6   54.5</span></span>
<span><span class="co">#&gt; 7  1    7   61.0</span></span>
<span><span class="co">#&gt; 8  1    8   65.0</span></span>
<span><span class="co">#&gt; 9  1    9   72.0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/xtabs.html" class="external-link">xtabs</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">id</span> <span class="op">+</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;    week</span></span>
<span><span class="co">#&gt; id  1 2 3 4 5 6 7 8 9</span></span>
<span><span class="co">#&gt;   1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   2 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   3 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/xtabs.html" class="external-link">xtabs</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">id</span> <span class="op">+</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;     week</span></span>
<span><span class="co">#&gt; id   1 2 3 4 5 6 7 8 9</span></span>
<span><span class="co">#&gt;   46 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   47 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   48 1 1 1 1 1 1 1 1 1</span></span></code></pre></div>
<p>Each of 48 pigs is observed weekly over a period of 9 weeks, with the
weight of the pig recorded in kg. The data are in “long” format, as is
appropriate for use with the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> function in the
<strong>lme4</strong> package. The data are very regular, with no
missing cases.</p>
<p>The following graph, showing the growth trajectories of the pigs, is
similar to Figure 3.1 in <span class="citation">Diggle et al.
(1994)</span>; we add an overall least-squares line and a loess smooth,
which are nearly indistinguishable:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span>, type <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Pigs</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">Pigs</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">9</span>,</span>
<span>    y <span class="op">=</span> <span class="va">Pigs</span><span class="op">[</span><span class="va">id</span> <span class="op">==</span> <span class="va">i</span>, <span class="st">"weight"</span><span class="op">]</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"gray"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>       lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">Pigs</span>, <span class="fu"><a href="https://rdrr.io/r/stats/scatter.smooth.html" class="external-link">loess.smooth</a></span><span class="op">(</span><span class="va">week</span>, <span class="va">weight</span>, span <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"magenta"</span>,</span>
<span>  lty <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig/pigs-graph-1.png" alt="Growth trajectories for 48 pigs, with overall least-squares line (sold blue) and loess line (broken magenta)." width="60%"><p class="caption">
Growth trajectories for 48 pigs, with overall least-squares line (sold
blue) and loess line (broken magenta).
</p>
</div>
<p>The individual “growth curves” and the overall trend are generally
linear, with some tendency for variability of pig weight to increase
over weeks (a feature of the data that we ignore in the mixed model that
we fit to the data below).</p>
<p>The <strong>Stata</strong> mixed-effects models manual proposes a
model with crossed random effects for the <code>Pigs</code> data <span class="citation">(StataCorp LLC, 2023, p. 37)</span>:</p>
<blockquote>
<p>[S]uppose that we wish to fit <span class="math display">\[
\mathrm{weight}_{ij} = \beta_0 + \beta_1 \mathrm{week}_{ij} + u_i + v_j
+ \varepsilon_{ij}
\]</span> for the <span class="math inline">\(i = 1, \ldots, 9\)</span>
weeks and <span class="math inline">\(j = 1, \dots, 48\)</span> pigs and
<span class="math display">\[
u_i \sim N(0, \sigma^2_u); v_j \sim N(0, \sigma^2_v ); \varepsilon_{ij}
\sim N(0, \sigma^2_\varepsilon)
\]</span> all independently. That is, we assume an overall
population-average growth curve <span class="math inline">\(\beta_0 +
\beta_1 \mathrm{week}\)</span> and a random pig-specific shift. In other
words, the effect due to week, <span class="math inline">\(u_i\)</span>,
is systematic to that week and common to all pigs. The rationale behind
[this model] could be that, assuming that the pigs were measured
contemporaneously, we might be concerned that week-specific random
factors such as weather and feeding patterns had significant systematic
effects on all pigs.</p>
</blockquote>
<p>Although we might prefer an alternative model,<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;These are repeated-measures data, which would be more
conventionally modeled with autocorrelated errors within pigs. The
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt; function in the &lt;strong&gt;nlme&lt;/strong&gt; package, for
example, is capable of fitting a mixed-model of this form.&lt;/p&gt;'><sup>6</sup></a> we think that this is
a reasonable specification.</p>
<p>The <strong>Stata</strong> manual fits the mixed model by maximum
likelihood (rather than REML), and we duplicate the results reported
there using <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span></span>
<span>  <span class="va">weight</span> <span class="op">~</span> <span class="va">week</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">week</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">Pigs</span>,</span>
<span>  REML <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># i.e., ML</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">lmerControl</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="st">"bobyqa"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.p</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by maximum likelihood  ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: weight ~ week + (1 | id) + (1 | week)</span></span>
<span><span class="co">#&gt;    Data: Pigs</span></span>
<span><span class="co">#&gt; Control: lmerControl(optimizer = "bobyqa")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span></span>
<span><span class="co">#&gt;   2037.6   2058.0  -1013.8   2027.6      427 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt; -3.775 -0.542  0.005  0.476  3.982 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  id       (Intercept) 14.836   3.852   </span></span>
<span><span class="co">#&gt;  week     (Intercept)  0.085   0.292   </span></span>
<span><span class="co">#&gt;  Residual              4.297   2.073   </span></span>
<span><span class="co">#&gt; Number of obs: 432, groups:  id, 48; week, 9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)  19.3556     0.6334    30.6</span></span>
<span><span class="co">#&gt; week          6.2099     0.0539   115.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correlation of Fixed Effects:</span></span>
<span><span class="co">#&gt;      (Intr)</span></span>
<span><span class="co">#&gt; week -0.426</span></span></code></pre></div>
<p>We opt for the non-default <code>"bobyqa"</code> optimizer because it
provides more numerically stable results for subsequent cross-validation
in this example.</p>
<p>We can then cross-validate the model by omitting folds composed of
pigs, folds composed of weeks, or folds composed of pig-weeks (which in
the <code>Pigs</code> data set correspond to individual cases, using
only the fixed effects):</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">m.p</span>, clusterVariables <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span><span class="co">#&gt; n-Fold Cross Validation based on 48 {id} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 19.973</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 19.965</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (17.125, 22.805)</span></span>
<span><span class="co">#&gt; full-sample criterion = 19.201</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">m.p</span>, clusterVariables <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span></span>
<span><span class="co">#&gt; boundary (singular) fit: see help('isSingular')</span></span>
<span><span class="co">#&gt; n-Fold Cross Validation based on 9 {week} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 19.312</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 19.305</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (16.566, 22.044)</span></span>
<span><span class="co">#&gt; full-sample criterion = 19.201</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span></span>
<span>  <span class="va">m.p</span>,</span>
<span>  clusterVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"week"</span><span class="op">)</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">8469</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 8469</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation based on 432 {id, week} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 19.235</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 19.233</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (16.493, 21.973)</span></span>
<span><span class="co">#&gt; full-sample criterion = 19.201</span></span></code></pre></div>
<p>We can also cross-validate the individual cases taking account of the
random effects (employing the same 10 folds):</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">m.p</span>, k <span class="op">=</span> <span class="fl">10</span>, seed <span class="op">=</span> <span class="fl">8469</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 8469</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 5.1583</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 5.0729</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (4.123, 6.0229)</span></span>
<span><span class="co">#&gt; full-sample criterion = 3.796</span></span></code></pre></div>
<p>Because these predictions are based on BLUPs, they are more accurate
than the predictions based only on fixed effects.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Even though there is only one observation per
combination of pigs and weeks, we can use the BLUP for the omitted case
because of the crossed structure of the random effects; that is each
pig-week has a pig random effect and a week random effect. Although it
probably isn’t sensible, we can imagine a mixed model for the pig data
that employs nested random effects, which would be specified by
&lt;code&gt;lmer(weight ~ week + (1 | id/week), data=Pigs)&lt;/code&gt;—that is, a
random intercept that varies by combinations of &lt;code&gt;id&lt;/code&gt; (pig)
and &lt;code&gt;week&lt;/code&gt;. This model can’t be fit, however: With only one
case per combination of &lt;code&gt;id&lt;/code&gt; and &lt;code&gt;week&lt;/code&gt;, the
nested random-effect variance is indistinguishable from the case-level
variance.&lt;/p&gt;"><sup>7</sup></a> As well, the
difference between the MSE computed for the model fit to the full data
and the CV estimates of the MSE is greater here than for cluster-based
predictions.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-BatesEtAl:2015" class="csl-entry">
Bates, D., Mächler, M., Bolker, B., &amp; Walker, S. (2015). Fitting
linear mixed-effects models using <span class="nocase">lme4</span>.
<em>Journal of Statistical Software</em>, <em>67</em>(1), 1–48.
</div>
<div id="ref-DiggleLiangZeger:1994" class="csl-entry">
Diggle, P. J., Liang, K.-Y., &amp; Zeger, S. L. (1994). <em>Analysis of
longitudinal data</em>. Oxford: Oxford University Press.
</div>
<div id="ref-FoxWeisberg:2019" class="csl-entry">
Fox, J., &amp; Weisberg, S. (2019). <em>An <span>R</span> companion to
applied regression</em> (Third edition). Thousand Oaks <span>CA</span>:
Sage.
</div>
<div id="ref-PinheiroBates:2000" class="csl-entry">
Pinheiro, J. C., &amp; Bates, D. M. (2000). <em>Mixed-effects models in
<span>S</span> and <span>S-PLUS</span></em>. New York: Springer.
</div>
<div id="ref-RaudenbushBryk:2002" class="csl-entry">
Raudenbush, S. W., &amp; Bryk, A. S. (2002). <em>Hierarchical linear
models: Applications and data analysis methods</em> (Second edition).
Thousand Oaks <span>CA</span>: Sage.
</div>
<div id="ref-Sarkar:2008" class="csl-entry">
Sarkar, D. (2008). <em>Lattice: Multivariate data visualization with
<span>R</span></em>. New York: Springer. Retrieved from <a href="http://lmdvr.r-forge.r-project.org" class="external-link">http://lmdvr.r-forge.r-project.org</a>
</div>
<div id="ref-SarkarAndrews:2022" class="csl-entry">
Sarkar, D., &amp; Andrews, F. (2022). <em><span class="nocase">latticeExtra</span>: Extra graphical utilities based on
<span class="nocase">lattice</span></em>. Retrieved from <a href="https://CRAN.R-project.org/package=latticeExtra" class="external-link">https://CRAN.R-project.org/package=latticeExtra</a>
</div>
<div id="ref-Stata:2023" class="csl-entry">
StataCorp LLC. (2023). <em>Stata multilevel mixed-effects reference
manual, release 18</em>. College Station <span>TX</span>: Stata Press.
Retrieved from <a href="https://www.stata.com/manuals/me.pdf" class="external-link">https://www.stata.com/manuals/me.pdf</a>
</div>
<div id="ref-Vehtari:2023" class="csl-entry">
Vehtari, A. (2023). Cross-validation <span>FAQ</span>. Retrieved October
15, 2023, from <a href="https://users.aalto.fi/~ave/CV-FAQ.html" class="external-link">https://users.aalto.fi/~ave/CV-FAQ.html</a>
</div>
<div id="ref-WickhamEtAl:2023" class="csl-entry">
Wickham, H., François, R., Henry, L., Müller, K., &amp; Vaughan, D.
(2023). <em>Dplyr: A grammar of data manipulation</em>. Retrieved from
<a href="https://CRAN.R-project.org/package=dplyr" class="external-link">https://CRAN.R-project.org/package=dplyr</a>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by John Fox, Georges Monette.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.8.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
