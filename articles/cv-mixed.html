<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Cross-validating mixed-effects models • cv</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cross-validating mixed-effects models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cv</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/cv.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cv-extend.html">Extending the cv package</a></li>
    <li><a class="dropdown-item" href="../articles/cv-mixed.html">Cross-validating mixed-effects models</a></li>
    <li><a class="dropdown-item" href="../articles/cv-notes.html">Computational and technical notes on cross-validating regression models</a></li>
    <li><a class="dropdown-item" href="../articles/cv-selection.html">Cross-validating model selection</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gmonette/cv/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Cross-validating mixed-effects models</h1>
                        <h4 data-toc-skip class="author">John Fox and
Georges Monette</h4>
            
            <h4 data-toc-skip class="date">2025-03-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/gmonette/cv/blob/main/vignettes/cv-mixed.Rmd" class="external-link"><code>vignettes/cv-mixed.Rmd</code></a></small>
      <div class="d-none name"><code>cv-mixed.Rmd</code></div>
    </div>

    
    
<p>The fundamental analogy for cross-validation is to the collection of
new data. That is, predicting the response in each fold from the model
fit to data in the other folds is like using the model fit to all of the
data to predict the response for new cases from the values of the
predictors for those new cases. As we explained in the introductory
vignette on cross-validating regression models, the application of this
idea to independently sampled cases is straightforward—simply partition
the data into random folds of equal size and leave each fold out in
turn, or, in the case of LOO CV, simply omit each case in turn.</p>
<p>In contrast, mixed-effects models are fit to <em>dependent</em> data,
in which cases as clustered, such as hierarchical data, where the
clusters comprise higher-level units (e.g., students clustered in
schools), or longitudinal data, where the clusters are individuals and
the cases repeated observations on the individuals over time.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;There are, however, more complex situations that give
rise to so-called &lt;em&gt;crossed&lt;/em&gt; (rather than &lt;em&gt;nested&lt;/em&gt;) random
effects. For example, consider students within classes within schools.
In primary schools, students typically are in a single class, and so
classes are nested within schools. In secondary schools, however,
students typically take several classes and students who are together in
a particular class may not be together in other classes; consequently,
random effects based on classes within schools are crossed. The
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link"&gt;lmer()&lt;/a&gt;&lt;/code&gt; function in the &lt;strong&gt;lme4&lt;/strong&gt; package is
capable of modeling both nested and crossed random effects, and the
&lt;code&gt;&lt;a href="../reference/cv.html"&gt;cv()&lt;/a&gt;&lt;/code&gt; methods for mixed models in the &lt;strong&gt;cv&lt;/strong&gt;
package pertain to both nested and crossed random effects. We present an
example of the latter later in the vignette.&lt;/p&gt;'><sup>1</sup></a></p>
<p>We can think of two approaches to applying cross-validation to
clustered data:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;We subsequently discovered that &lt;span class="citation"&gt;Vehtari (2023, sec. 8)&lt;/span&gt; makes similar points.&lt;/p&gt;'><sup>2</sup></a></p>
<ol style="list-style-type: decimal">
<li><p>Treat CV as analogous to predicting the response for one or more
cases in a <em>newly observed cluster</em>. In this instance, the folds
comprise one or more whole clusters; we refit the model with all of the
cases in clusters in the current fold removed; and then we predict the
response for the cases in clusters in the current fold. These
predictions are based only on fixed effects because the random effects
for the omitted clusters are presumably unknown, as they would be for
data on cases in newly observed clusters.</p></li>
<li><p>Treat CV as analogous to predicting the response for a newly
observed case in an <em>existing cluster</em>. In this instance, the
folds comprise one or more individual cases, and the predictions can use
both the fixed and random effects.</p></li>
</ol>
<div class="section level2">
<h2 id="example-the-high-school-and-beyond-data">Example: The High-School and Beyond data<a class="anchor" aria-label="anchor" href="#example-the-high-school-and-beyond-data"></a>
</h2>
<p>Following their use by <span class="citation">Raudenbush &amp; Bryk
(2002)</span>, data from the 1982 <em>High School and Beyond</em> (HSB)
survey have become a staple of the literature on mixed-effects models.
The HSB data are used by <span class="citation">Fox &amp; Weisberg
(2019, sec. 7.2.2)</span> to illustrate the application of linear mixed
models to hierarchical data, and we’ll closely follow their example
here.</p>
<p>The HSB data are included in the <code>MathAchieve</code> and
<code>MathAchSchool</code> data sets in the <strong>nlme</strong>
package <span class="citation">(Pinheiro &amp; Bates, 2000)</span>.
<code>MathAchieve</code> includes individual-level data on 7185 students
in 160 high schools, and <code>MathAchSchool</code> includes
school-level data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"MathAchieve"</span>, package <span class="op">=</span> <span class="st">"nlme"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">MathAchieve</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7185    6</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">MathAchieve</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Grouped Data: MathAch ~ SES | School</span></span>
<span><span class="co">#&gt;   School Minority    Sex    SES MathAch MEANSES</span></span>
<span><span class="co">#&gt; 1   1224       No Female -1.528   5.876  -0.428</span></span>
<span><span class="co">#&gt; 2   1224       No Female -0.588  19.708  -0.428</span></span>
<span><span class="co">#&gt; 3   1224       No   Male -0.528  20.349  -0.428</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">MathAchieve</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Grouped Data: MathAch ~ SES | School</span></span>
<span><span class="co">#&gt;      School Minority    Sex    SES MathAch MEANSES</span></span>
<span><span class="co">#&gt; 7183   9586       No Female  1.332  19.641   0.627</span></span>
<span><span class="co">#&gt; 7184   9586       No Female -0.008  16.241   0.627</span></span>
<span><span class="co">#&gt; 7185   9586       No Female  0.792  22.733   0.627</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"MathAchSchool"</span>, package <span class="op">=</span> <span class="st">"nlme"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">MathAchSchool</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 160   7</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">MathAchSchool</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;      School Size Sector PRACAD DISCLIM HIMINTY MEANSES</span></span>
<span><span class="co">#&gt; 1224   1224  842 Public   0.35   1.597       0  -0.428</span></span>
<span><span class="co">#&gt; 1288   1288 1855 Public   0.27   0.174       0   0.128</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">MathAchSchool</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt;      School Size   Sector PRACAD DISCLIM HIMINTY MEANSES</span></span>
<span><span class="co">#&gt; 9550   9550 1532   Public   0.45   0.791       0   0.059</span></span>
<span><span class="co">#&gt; 9586   9586  262 Catholic   1.00  -2.416       0   0.627</span></span></code></pre></div>
<p>The first few students are in school number 1224 and the last few in
school 9586.</p>
<p>We’ll use only the <code>School</code>, <code>SES</code> (students’
socioeconomic status), and <code>MathAch</code> (their score on a
standardized math-achievement test) variables in the
<code>MathAchieve</code> data set, and <code>Sector</code>
(<code>"Catholic"</code> or <code>"Public"</code>) in the
<code>MathAchSchool</code> data set.</p>
<p>Some data-management is required before fitting a mixed-effects model
to the HSB data, for which we use the <strong>dplyr</strong> package
<span class="citation">(Wickham, François, Henry, Müller, &amp; Vaughan,
2023)</span>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="va">MathAchieve</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">School</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mean.ses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">SES</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">Temp</span></span>
<span><span class="va">Temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">MathAchSchool</span>, <span class="va">Temp</span>, by <span class="op">=</span> <span class="st">"School"</span><span class="op">)</span></span>
<span><span class="va">HSB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">Temp</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"School"</span>, <span class="st">"Sector"</span>, <span class="st">"mean.ses"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>             <span class="va">MathAchieve</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"School"</span>, <span class="st">"SES"</span>, <span class="st">"MathAch"</span><span class="op">)</span><span class="op">]</span>, by <span class="op">=</span> <span class="st">"School"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">HSB</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">HSB</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">HSB</span><span class="op">$</span><span class="va">cses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">HSB</span>, <span class="va">ses</span> <span class="op">-</span> <span class="va">mean.ses</span><span class="op">)</span></span></code></pre></div>
<p>In the process, we created two new school-level variables:
<code>meanses</code>, which is the average SES for students in each
school; and <code>cses</code>, which is school-average SES centered at
its mean. For details, see <span class="citation">Fox &amp; Weisberg
(2019, sec. 7.2.2)</span>.</p>
<p>Still following Fox and Weisberg, we proceed to use the
<code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> function in the <strong>lme4</strong> package <span class="citation">(Bates, Mächler, Bolker, &amp; Walker, 2015)</span> to
fit a mixed model for math achievement to the HSB data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/lme4/lme4/" class="external-link">"lme4"</a></span><span class="op">)</span></span>
<span><span class="va">hsb.lmer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">mathach</span> <span class="op">~</span> <span class="va">mean.ses</span> <span class="op">*</span> <span class="va">cses</span> <span class="op">+</span> <span class="va">sector</span> <span class="op">*</span> <span class="va">cses</span></span>
<span>                 <span class="op">+</span> <span class="op">(</span><span class="va">cses</span> <span class="op">|</span> <span class="va">school</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">HSB</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hsb.lmer</span>, correlation <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by REML ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: mathach ~ mean.ses * cses + sector * cses + (cses | school)</span></span>
<span><span class="co">#&gt;    Data: HSB</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; REML criterion at convergence: 46504</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt; -3.159 -0.723  0.017  0.754  2.958 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev. Corr</span></span>
<span><span class="co">#&gt;  school   (Intercept)  2.380   1.543        </span></span>
<span><span class="co">#&gt;           cses         0.101   0.318    0.39</span></span>
<span><span class="co">#&gt;  Residual             36.721   6.060        </span></span>
<span><span class="co">#&gt; Number of obs: 7185, groups:  school, 160</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;                     Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)           12.128      0.199   60.86</span></span>
<span><span class="co">#&gt; mean.ses               5.333      0.369   14.45</span></span>
<span><span class="co">#&gt; cses                   2.945      0.156   18.93</span></span>
<span><span class="co">#&gt; sectorCatholic         1.227      0.306    4.00</span></span>
<span><span class="co">#&gt; mean.ses:cses          1.039      0.299    3.48</span></span>
<span><span class="co">#&gt; cses:sectorCatholic   -1.643      0.240   -6.85</span></span></code></pre></div>
<p>We can then cross-validate at the cluster (i.e., school) level,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://gmonette.github.io/cv/">"cv"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lmer</span>,</span>
<span>   k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>   clusterVariables <span class="op">=</span> <span class="st">"school"</span>,</span>
<span>   seed <span class="op">=</span> <span class="fl">5240</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 5240</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation based on 160 {school} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 39.157</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 39.148</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (38.066, 40.231)</span></span>
<span><span class="co">#&gt; full-sample criterion = 39.006</span></span></code></pre></div>
<p>or at the case (i.e., student) level,</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lmer</span>, seed <span class="op">=</span> <span class="fl">1575</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 1575</span></span>
<span><span class="co">#&gt; Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :</span></span>
<span><span class="co">#&gt; Model failed to converge with max|grad| = 0.00587207 (tol = 0.002, component 1)</span></span>
<span><span class="co">#&gt; boundary (singular) fit: see help('isSingular')</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 37.445</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 37.338</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (36.288, 38.388)</span></span>
<span><span class="co">#&gt; full-sample criterion = 36.068</span></span></code></pre></div>
<p>For cluster-level CV, the <code>clusterVariables</code> argument
tells <code><a href="../reference/cv.html">cv()</a></code> how the clusters are defined. Were there more
than one clustering variable, say classes within schools, these would be
provided as a character vector of variable names:
<code>clusterVariables = c("school", "class")</code>. For cluster-level
CV, the default is <code>k = "loo"</code>, that is, leave one cluster
out at a time; we instead specify <code>k = 10</code> folds of clusters,
each fold therefore comprising
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>160</mn><mi>/</mi><mn>10</mn><mo>=</mo><mn>16</mn></mrow><annotation encoding="application/x-tex">160/10 = 16</annotation></semantics></math>
schools.</p>
<p>If the <code>clusterVariables</code> argument is omitted, then
case-level CV is employed, with <code>k = 10</code> folds as the
default, here each with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7185</mn><mi>/</mi><mn>10</mn><mo>≈</mo><mn>719</mn></mrow><annotation encoding="application/x-tex">7185/10 \approx 719</annotation></semantics></math>
students. Notice that one of the 10 models refit with a fold removed
failed to converge. Convergence problems are common in mixed-effects
modeling. The apparent issue here is that an estimated variance
component is close to or equal to 0, which is at a boundary of the
parameter space. That shouldn’t disqualify the fitted model for the kind
of prediction required for cross-validation.</p>
<p>There is also a <code><a href="../reference/cv.html">cv()</a></code> method for linear mixed models fit
by the <code><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme()</a></code> function in the <strong>nlme</strong> package,
and the arguments for <code><a href="../reference/cv.html">cv()</a></code> in this case are the same as for
a model fit by <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> or <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html" class="external-link">glmer()</a></code>. We
illustrate with the mixed model fit to the HSB data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://svn.r-project.org/R-packages/trunk/nlme/" class="external-link">"nlme"</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'nlme'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     collapse</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:lme4':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     lmList</span></span>
<span><span class="va">hsb.lme</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme</a></span><span class="op">(</span></span>
<span>  <span class="va">mathach</span> <span class="op">~</span> <span class="va">mean.ses</span> <span class="op">*</span> <span class="va">cses</span> <span class="op">+</span> <span class="va">sector</span> <span class="op">*</span> <span class="va">cses</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span> <span class="va">cses</span> <span class="op">|</span> <span class="va">school</span>,</span>
<span>  data <span class="op">=</span> <span class="va">HSB</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>opt <span class="op">=</span> <span class="st">"optim"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">hsb.lme</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed-effects model fit by REML</span></span>
<span><span class="co">#&gt;   Data: HSB </span></span>
<span><span class="co">#&gt;     AIC   BIC logLik</span></span>
<span><span class="co">#&gt;   46525 46594 -23252</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Formula: ~cses | school</span></span>
<span><span class="co">#&gt;  Structure: General positive-definite, Log-Cholesky parametrization</span></span>
<span><span class="co">#&gt;             StdDev   Corr  </span></span>
<span><span class="co">#&gt; (Intercept) 1.541177 (Intr)</span></span>
<span><span class="co">#&gt; cses        0.018174 0.006 </span></span>
<span><span class="co">#&gt; Residual    6.063492       </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:  mathach ~ mean.ses * cses + sector * cses </span></span>
<span><span class="co">#&gt;                       Value Std.Error   DF t-value p-value</span></span>
<span><span class="co">#&gt; (Intercept)         12.1282   0.19920 7022  60.886   0e+00</span></span>
<span><span class="co">#&gt; mean.ses             5.3367   0.36898  157  14.463   0e+00</span></span>
<span><span class="co">#&gt; cses                 2.9421   0.15122 7022  19.456   0e+00</span></span>
<span><span class="co">#&gt; sectorCatholic       1.2245   0.30611  157   4.000   1e-04</span></span>
<span><span class="co">#&gt; mean.ses:cses        1.0444   0.29107 7022   3.588   3e-04</span></span>
<span><span class="co">#&gt; cses:sectorCatholic -1.6421   0.23312 7022  -7.044   0e+00</span></span>
<span><span class="co">#&gt;  Correlation: </span></span>
<span><span class="co">#&gt;                     (Intr) men.ss cses   sctrCt mn.ss:</span></span>
<span><span class="co">#&gt; mean.ses             0.256                            </span></span>
<span><span class="co">#&gt; cses                 0.000  0.000                     </span></span>
<span><span class="co">#&gt; sectorCatholic      -0.699 -0.356  0.000              </span></span>
<span><span class="co">#&gt; mean.ses:cses        0.000  0.000  0.295  0.000       </span></span>
<span><span class="co">#&gt; cses:sectorCatholic  0.000  0.000 -0.696  0.000 -0.351</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Standardized Within-Group Residuals:</span></span>
<span><span class="co">#&gt;       Min        Q1       Med        Q3       Max </span></span>
<span><span class="co">#&gt; -3.170106 -0.724877  0.014892  0.754263  2.965498 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of Observations: 7185</span></span>
<span><span class="co">#&gt; Number of Groups: 160</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lme</span>,</span>
<span>   k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>   clusterVariables <span class="op">=</span> <span class="st">"school"</span>,</span>
<span>   seed <span class="op">=</span> <span class="fl">5240</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 5240</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation based on 160 {school} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 39.157</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 39.149</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (38.066, 40.232)</span></span>
<span><span class="co">#&gt; full-sample criterion = 39.006</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">hsb.lme</span>, seed <span class="op">=</span> <span class="fl">1575</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 1575</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 37.442</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 37.402</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (36.351, 38.453)</span></span>
<span><span class="co">#&gt; full-sample criterion = 36.147</span></span></code></pre></div>
<p>We used the same random-number generator seeds as in the previous
example cross-validating the model fit by <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code>, and so
the same folds are employed in both cases.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;The observant reader will notice that we set the
argument &lt;code&gt;control=list(opt="optim")&lt;/code&gt; in the call to
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt;, changing the optimizer employed from the default
&lt;code&gt;"nlminb"&lt;/code&gt;. We did this because with the default optimizer,
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt; encountered the same convergence issue as
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link"&gt;lmer()&lt;/a&gt;&lt;/code&gt;, but rather than issuing a warning,
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt; failed, reporting an error. As it turns out, setting
the optimizer to &lt;code&gt;"optim"&lt;/code&gt; avoids this problem.&lt;/p&gt;'><sup>3</sup></a> The estimated
covariance components and fixed effects in the summary output differ
slightly between the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> and <code><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme()</a></code>
solutions, although both functions seek to maximize the REML criterion.
This is, of course, to be expected when different algorithms are used
for numerical optimization. To the precision reported, the cluster-level
CV results for the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> and <code><a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link">lme()</a></code> models are
identical, while the case-level CV results are very similar but not
identical.</p>
</div>
<div class="section level2">
<h2 id="example-contrasting-cluster-based-and-case-based-cv">Example: Contrasting cluster-based and case-based CV<a class="anchor" aria-label="anchor" href="#example-contrasting-cluster-based-and-case-based-cv"></a>
</h2>
<p>We introduce four artificial data sets that exemplify aspects of
cross-validation particular to hierarchical models. Using these data
sets, we show that model comparisons employing cluster-based and those
employing case-based cross-validation may not agree on a “best” model.
Furthermore, commonly used measures of fit, such as mean-squared error,
do not necessarily become smaller as models become larger, even when the
models are nested, and even when the measure of fit is computed for the
whole data set.</p>
<p>The four datasets differ in the relative magnitude of between-cluster
variance compared with within-cluster variance. They serve to illustrate
how fitting mixed models, and, consequently, the cross-validation of
mixed models, is sensitive to relative variance, which determines the
degree of shrinkage of within-cluster estimates of effects towards
between-cluster estimates.</p>
<p>For these analyses, we will use the <code><a href="https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html" class="external-link">glmmTMB()</a></code> function
in the <strong>glmmTMB</strong> package <span class="citation">(Brooks
et al., 2017)</span> because, in our experience, it is more likely to
converge than functions in the <strong>nlme</strong> and the
<strong>lme4</strong> packages for models with low between-cluster
variance.</p>
<p>Consider a researcher studying the effect of the dosage of a drug on
the severity of symptoms for a hypothetical disease. The researcher has
longitudinal data on 20 patients, each of whom was observed on five
occasions in which patients received different dosages of the drug. The
data are observational, with dosages prescribed by the patients’
physicians, so that patients who were more severely affected by the
disease received higher dosages of the drug.</p>
<p>Our four contrived data sets (see below) illustrate possible results
for data obtained in such a scenario. The relative configuration of
dosages <code>x</code> and symptoms <code>y</code> are identical within
patients in each of the four datasets. Within patients, higher dosages
are generally associated with a reduction in symptoms.</p>
<p>Between patients, however, higher dosages are associated with higher
levels of symptoms. A plausible mechanism is a reversal of causality:
Within patients, higher dosages alleviate symptoms, but between patients
higher morbidity causes the prescription of higher dosages.</p>
<p>The four data sets differ in the between-patient variance of patient
centroids from a common between-patients regression line. The data sets
exhibit a progression from low to high variance around the common
regression line.</p>
<p>We start by generating a data set to serve as a common template for
the four sample data sets. We then apply different multipliers to the
between-patient variation using parameters consistent with the
description above to highlight the issues that arise in cross-validating
mixed-effects models:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;We invite the interested reader to experiment with
varying the parameters of our example.&lt;/p&gt;"><sup>4</sup></a></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Parameters:</span></span>
<span></span>
<span><span class="va">Nb</span> <span class="op">&lt;-</span> <span class="fl">20</span>     <span class="co"># number of patients</span></span>
<span><span class="va">Nw</span> <span class="op">&lt;-</span> <span class="fl">5</span>      <span class="co"># number of occasions for each patient</span></span>
<span></span>
<span><span class="va">Bb</span> <span class="op">&lt;-</span> <span class="fl">1.0</span>    <span class="co"># between-patient regression coefficient on patient means</span></span>
<span><span class="va">Bw</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.5</span>   <span class="co"># within-patient effect of x</span></span>
<span></span>
<span><span class="va">SD_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>               <span class="co"># SD between patients</span></span>
<span><span class="va">SD_within</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">SD_between</span><span class="op">)</span><span class="op">)</span> <span class="co"># SD within patients</span></span>
<span></span>
<span><span class="va">Nv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">SD_within</span><span class="op">)</span>       <span class="co"># number of variance profiles</span></span>
<span><span class="va">SD_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'SD ratio = '</span>, <span class="va">SD_between</span>,<span class="st">' / '</span>,<span class="va">SD_within</span><span class="op">)</span></span>
<span><span class="va">SD_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">SD_ratio</span>, levels <span class="op">=</span> <span class="va">SD_ratio</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">833885</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">Data_template</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>patient <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">Nb</span>, obs <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">Nw</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">xw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">2</span>, length.out <span class="op">=</span> <span class="va">Nw</span><span class="op">)</span><span class="op">[</span><span class="va">obs</span><span class="op">]</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">patient</span> <span class="op">+</span> <span class="va">xw</span></span>
<span>    <span class="va">xm</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html" class="external-link">ave</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">patient</span><span class="op">)</span>   <span class="co"># within-patient mean</span></span>
<span></span>
<span>    <span class="co"># Scaled random error within each SD_ratio_i group</span></span>
<span></span>
<span>    <span class="va">re_std</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">Nb</span><span class="op">*</span><span class="va">Nw</span><span class="op">)</span> <span class="op">~</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">re_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html" class="external-link">ave</a></span><span class="op">(</span><span class="va">re_std</span>, <span class="va">patient</span><span class="op">)</span></span>
<span>    <span class="va">re_within</span> <span class="op">&lt;-</span> <span class="va">re_std</span> <span class="op">-</span> <span class="va">re_between</span></span>
<span>    <span class="va">re_between</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">re_between</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">Nw</span><span class="op">)</span></span>
<span>    <span class="va">re_within</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">re_within</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="va">rbind</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="va">Nv</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Data_template</span>, SD_ratio_i <span class="op">=</span> <span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">Data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span></span>
<span>  <span class="va">Data</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">SD_within_</span> <span class="op">&lt;-</span> <span class="va">SD_within</span><span class="op">[</span><span class="va">SD_ratio_i</span><span class="op">]</span></span>
<span>    <span class="va">SD_between_</span> <span class="op">&lt;-</span> <span class="va">SD_between</span><span class="op">[</span><span class="va">SD_ratio_i</span><span class="op">]</span></span>
<span>    <span class="va">SD_ratio</span> <span class="op">&lt;-</span> <span class="va">SD_ratio</span><span class="op">[</span><span class="va">SD_ratio_i</span><span class="op">]</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">+</span></span>
<span>      <span class="va">Bb</span> <span class="op">*</span> <span class="va">xm</span> <span class="op">+</span>                  <span class="co"># contextual effect</span></span>
<span>      <span class="va">Bw</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">xm</span><span class="op">)</span> <span class="op">+</span>            <span class="co"># within-patient effect</span></span>
<span>      <span class="va">SD_within_</span> <span class="op">*</span> <span class="va">re_within</span> <span class="op">+</span>   <span class="co"># within patient random effect</span></span>
<span>      <span class="va">SD_between_</span> <span class="op">*</span> <span class="va">re_between</span>   <span class="co"># adjustment to between patient random effect</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here is a scatterplot of the data sets showing estimated 50%
concentration ellipses for each cluster:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;We find it convenient to use the
&lt;strong&gt;lattice&lt;/strong&gt; &lt;span class="citation"&gt;(Sarkar, 2008)&lt;/span&gt;
and &lt;strong&gt;latticeExtra&lt;/strong&gt; &lt;span class="citation"&gt;(Sarkar &amp;amp;
Andrews, 2022)&lt;/span&gt; packages for this and other graphs in this
section.&lt;/p&gt;'><sup>5</sup></a></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://lattice.r-forge.r-project.org/" class="external-link">"lattice"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://latticeextra.r-forge.r-project.org/" class="external-link">"latticeExtra"</a></span><span class="op">)</span></span>
<span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">|</span> <span class="va">SD_ratio</span>, data <span class="op">=</span> <span class="va">Data</span>, group <span class="op">=</span> <span class="va">patient</span>,</span>
<span>           layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Nv</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>           par.settings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>superpose.symbol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pch <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/layer.html" class="external-link">layer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/panel.ellipse.html" class="external-link">panel.ellipse</a></span><span class="op">(</span><span class="va">...</span>, center.pch <span class="op">=</span> <span class="fl">16</span>, center.cex <span class="op">=</span> <span class="fl">1.5</span>,  </span>
<span>                          level <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/panel.functions.html" class="external-link">panel.abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">10</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">plot</span> <span class="co"># display graph</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig%2Fplot1-1.png" alt="Data sets showing identical within-patient configurations with increasing between-patient variance. The labels above each panel show the between-patient SD/within-patient SD. The ellipses are estimated 50% concentration ellipses for each patient. The population between-patient regression line, $E(y) = 10 + x$, is shown in each panel." width="100%"><p class="caption">
Data sets showing identical within-patient configurations with
increasing between-patient variance. The labels above each panel show
the between-patient SD/within-patient SD. The ellipses are estimated 50%
concentration ellipses for each patient. The population between-patient
regression line,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>y</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>10</mn><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">E(y) = 10 + x</annotation></semantics></math>,
is shown in each panel.
</p>
</div>
<p>The population from which these datasets is generated has a
between-patient effect of dosage of 1 and a within-patient effect of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">-0.5</annotation></semantics></math>.
The researcher may attempt to obtain an estimate of the within-patient
effect of dosage through the use of mixed models with a random
intercept. We will illustrate how this approach results in estimates
that are highly sensitive to the relative variance at the two levels of
the mixed model by considering four models, all of which include a
random intercept. The first three models have sequentially nested fixed
effects: (1)<code>~ 1</code>, intercept only; (2)<code>~ 1 + x</code>,
intercept and effect of <code>x</code>; and (3)
<code>~ 1 + x + xm</code>, intercept, effect of <code>x</code>, and a
contextual variable, <code>xm</code>, consisting of the within-patient
mean of <code>x</code>. The fourth model, <code>~ 1 + I(x - xm)</code>,
uses an intercept and the centered-within-group variable
<code>x - xm</code>. We thus fit four models to four datasets for a
total of 16 models.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model.formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">' ~ 1'</span>             <span class="op">=</span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">patient</span><span class="op">)</span>,</span>
<span>  <span class="st">'~ 1 + x'</span>          <span class="op">=</span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">patient</span><span class="op">)</span>,</span>
<span>  <span class="st">'~ 1 + x + xm'</span>     <span class="op">=</span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">xm</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">patient</span><span class="op">)</span>,</span>
<span>  <span class="st">'~ 1 + I(x - xm)'</span>  <span class="op">=</span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">xm</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">patient</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">Data</span>, <span class="op">~</span> <span class="va">SD_ratio</span><span class="op">)</span>,</span>
<span>               <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">model.formulas</span>, <span class="kw">function</span><span class="op">(</span><span class="va">form</span><span class="op">)</span> <span class="op">{</span></span>
<span>                   <span class="fu"><a href="https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html" class="external-link">glmmTMB</a></span><span class="op">(</span><span class="va">form</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span>                 <span class="op">}</span><span class="op">)</span></span>
<span>               <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>We proceed to obtain predictions from each model based on fixed
effects alone, as would be used for cross-validation based on clusters
(i.e., patients), and for fixed and random effects—so-called best linear
unbiased predictions or “BLUPs”—as would be used for cross-validation
based on cases (i.e., occasions within patients):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># predicted fixed and random effects:</span></span>
<span><span class="va">pred.BLUPs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="va">lapply</span>, <span class="va">predict</span><span class="op">)</span></span>
<span><span class="co"># predicted fixed effects:</span></span>
<span><span class="va">pred.fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="va">lapply</span>, <span class="va">predict</span>, re.form <span class="op">=</span> <span class="op">~</span><span class="fl">0</span><span class="op">)</span>  </span></code></pre></div>
<p>We then prepare the data for plotting:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Dataf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">Data</span>, <span class="op">~</span> <span class="va">SD_ratio</span><span class="op">)</span>,</span>
<span>                    <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model.formulas</span><span class="op">)</span>, </span>
<span>                             <span class="kw">function</span><span class="op">(</span><span class="va">form</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">d</span>, formula <span class="op">=</span> <span class="va">form</span><span class="op">)</span><span class="op">)</span></span>
<span>                    <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">dlist</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">dlist</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, args <span class="op">=</span> <span class="va">_</span><span class="op">)</span></span>
<span>    </span>
<span><span class="va">Dataf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span></span>
<span>  <span class="va">Dataf</span>,</span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">pred.fixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">pred.fixed</span><span class="op">)</span></span>
<span>    <span class="va">pred.BLUPs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">pred.BLUPs</span><span class="op">)</span></span>
<span>    <span class="va">panel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">formula</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model.formulas</span><span class="op">)</span>, <span class="st">'data'</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">Data</span><span class="op">$</span><span class="va">panel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">'data'</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">model.formulas</span><span class="op">)</span>, <span class="st">'data'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The fixed-effects predictions from these models are shown in the
following graph:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">|</span><span class="va">SD_ratio</span> <span class="op">*</span> <span class="va">panel</span>, <span class="va">Data</span>,</span>
<span>         groups <span class="op">=</span> <span class="va">patient</span>, type <span class="op">=</span> <span class="st">'n'</span>, </span>
<span>         par.strip.text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>         drop.unused.levels <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/layer.html" class="external-link">glayer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/panel.ellipse.html" class="external-link">panel.ellipse</a></span><span class="op">(</span><span class="va">...</span>, center.pch <span class="op">=</span> <span class="fl">16</span>, center.cex <span class="op">=</span> <span class="fl">0.5</span>,  </span>
<span>                         level <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/panel.functions.html" class="external-link">panel.abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">10</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span><span class="va">pred.fixed</span>  <span class="op">~</span> <span class="va">x</span> <span class="op">|</span><span class="va">SD_ratio</span> <span class="op">*</span> <span class="va">panel</span>, <span class="va">Dataf</span>, type <span class="op">=</span> <span class="st">'l'</span>, </span>
<span>           groups <span class="op">=</span> <span class="va">patient</span>,</span>
<span>           drop.unused.levels <span class="op">=</span> <span class="cn">F</span>,</span>
<span>           ylab <span class="op">=</span> <span class="st">'fixed-effect predictions'</span><span class="op">)</span> </span>
<span><span class="op">}</span><span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/useOuterStrips.html" class="external-link">useOuterStrips</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig%2Fplot-fits-fixed-1.png" alt="Fixed-effect predictions using each model applied to data sets with varying between- and within-patient variance ratios.  The top row shows summaries of the within-patient data using estimated 50% concentration ellipses for each patient." width="100%"><p class="caption">
Fixed-effect predictions using each model applied to data sets with
varying between- and within-patient variance ratios. The top row shows
summaries of the within-patient data using estimated 50% concentration
ellipses for each patient.
</p>
</div>
<p>The BLUPs from these models are shown in the following graph:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">|</span> <span class="va">SD_ratio</span> <span class="op">*</span> <span class="va">panel</span>, <span class="va">Data</span>,</span>
<span>         groups <span class="op">=</span> <span class="va">patient</span>, type <span class="op">=</span> <span class="st">'n'</span>,</span>
<span>         drop.unused.levels <span class="op">=</span> <span class="cn">F</span>, </span>
<span>         par.strip.text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cex <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>         ylab <span class="op">=</span> <span class="st">'fixed- and random-effect predictions (BLUPS)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/layer.html" class="external-link">glayer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/panel.ellipse.html" class="external-link">panel.ellipse</a></span><span class="op">(</span><span class="va">...</span>, center.pch <span class="op">=</span> <span class="fl">16</span>, center.cex <span class="op">=</span> <span class="fl">0.5</span>,  </span>
<span>                         level <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/panel.functions.html" class="external-link">panel.abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">10</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span><span class="va">pred.BLUPs</span>  <span class="op">~</span> <span class="va">x</span> <span class="op">|</span> <span class="va">SD_ratio</span> <span class="op">*</span> <span class="va">panel</span>, <span class="va">Dataf</span>, type <span class="op">=</span> <span class="st">'l'</span>, </span>
<span>           groups <span class="op">=</span> <span class="va">patient</span>,</span>
<span>           drop.unused.levels <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> </span>
<span><span class="op">}</span><span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/latticeExtra/man/useOuterStrips.html" class="external-link">useOuterStrips</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig%2Fplot-fits-blups-1.png" alt="Fixed- and random-effect predictions (BLUPs) using each model applied to data sets with varying between- and within-patient variance ratios. The top row shows summaries of the within-patient data using estimated 50% concentration ellipses for each patient." width="100%"><p class="caption">
Fixed- and random-effect predictions (BLUPs) using each model applied to
data sets with varying between- and within-patient variance ratios. The
top row shows summaries of the within-patient data using estimated 50%
concentration ellipses for each patient.
</p>
</div>
<p>Data sets with relatively low between-patient variance result in
strong shrinkage of fixed-effects predictions and also of BLUPs towards
the between-patient relationship between <code>y</code> and
<code>x</code> in the model with an intercept and <code>x</code> as
fixed-effect predictors, <code>~ 1 + x</code>. The inclusion of a
contextual variable in the model corrects this problem.</p>
<p>Although the BLUPs fit the observed data more closely than
predictions based on fixed effects alone, the slopes of within-patient
BLUPs do not conform with the within-patient slopes for the
<code>~ 1 + x</code> model in the two datasets with the smallest
between-patient variances.</p>
<p>For data with a small between-patient variance, fixed-effects
predictions for the <code>~ 1 + x</code> model have a slope that is
close to the between-patient slope but provide better overall
predictions than the fixed-effect predictions for datasets with larger
between-subject variance. With data whose between-patient variance is
relatively large, predictions based on the model with a common intercept
and slope for all clusters, are very poor—indeed, much worse than the
fixed-effects-only predictions based on the simpler random-intercept
model.</p>
<p>We therefore anticipate (and show later in this section) that
case-based cross-validation may prefer the intercept-only model,
<code>~ 1</code> to the larger <code>~ 1 + x</code> model when the
between-cluster variance is relatively small, but that cluster-based
cross-validation will prefer the latter to the former.</p>
<p>We will discover that case-based cross-validation prefers the
<code>~ 1 + x</code> model to the <code>~ 1</code> model for the ‘5 /
2.5’ dataset, but cluster-based cross-validation prefers the latter
model to the former. The situation is entirely reversed with the ‘8 /
2.5’ dataset.</p>
<p>The third model, <code>~ 1 + x + xm</code>, includes a contextual
effect of <code>x</code>—that is, the cluster mean <code>xm</code>—along
with <code>x</code> and the intercept in the fixed-effect part of the
model, along with a random intercept. This model is equivalent to
fitting <code>y ~ I(x - xm) + xm + (1 | patient)</code>, which is the
model that generated the data. The fit of the mixed model
<code>~ 1 + x + xm</code> is consequently similar to that of a
fixed-effects only model with <code>x</code> and a categorical predictor
for individual patients (i.e., <code>y ~ factor(patient) + x</code>,
treating patients as a factor, and not shown here).</p>
<p>We next carry out case-based cross-validation, which, as we have
explained, is based on both fixed and predicted random effects (i.e.,
BLUPs), and cluster-based cross-validation, which is based on fixed
effects only. In order to reduce between-model random variability in
comparisons of models on the same dataset, we apply <code><a href="../reference/cv.html">cv()</a></code> to
the list of models created by the <code><a href="../reference/cv.modList.html">models()</a></code> function
(introduced previously), performing cross-validation with the same folds
for each model.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">model_lists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fits</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fitlist</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">models</span>, <span class="va">fitlist</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cvs_cases</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Nv</span>,</span>
<span>         <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>           <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">model_lists</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, k <span class="op">=</span> <span class="fl">10</span>, </span>
<span>              data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">Data</span>, <span class="op">~</span> <span class="va">SD_ratio</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>         <span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 982470</span></span>
<span><span class="co">#&gt; R RNG seed set to 903914</span></span>
<span><span class="co">#&gt; R RNG seed set to 246168</span></span>
<span><span class="co">#&gt; R RNG seed set to 948407</span></span>
<span></span>
<span><span class="va">cvs_clusters</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">Nv</span>,</span>
<span>         <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>           <span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">model_lists</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,  k <span class="op">=</span> <span class="fl">10</span>, </span>
<span>              data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">Data</span>, <span class="op">~</span><span class="va">SD_ratio</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, </span>
<span>              clusterVariables <span class="op">=</span> <span class="st">'patient'</span><span class="op">)</span></span>
<span>         <span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 382198</span></span>
<span><span class="co">#&gt; R RNG seed set to 533366</span></span>
<span><span class="co">#&gt; R RNG seed set to 637459</span></span>
<span><span class="co">#&gt; R RNG seed set to 542289</span></span></code></pre></div>
<p>For a given dataset, we can plot the results for a list of models
using the plot method for <code>"cvList"</code> objects. For example</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cvs_clusters</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, main<span class="op">=</span><span class="st">"Comparison of Fixed Effects"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig%2Fplot-cv-example-1.png" alt="10-fold cluster-based cross-validation comparing random intercept mixed models with varying fixed effects." width="60%"><p class="caption">
10-fold cluster-based cross-validation comparing random intercept mixed
models with varying fixed effects.
</p>
</div>
<p>We assemble the results for all datasets to show them in a common
figure.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cvs_clusters</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cvs_cases</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">SD_ratio</span> </span>
<span><span class="va">dsummary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>SD_ratio_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cvs_cases</span><span class="op">)</span>, model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cvs_cases</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dsummary</span><span class="op">$</span><span class="va">cases</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dsummary</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">dsummary</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="va">cvs_cases</span><span class="op">[[</span><span class="va">SD_ratio_i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">model</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'CV crit'</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dsummary</span><span class="op">$</span><span class="va">clusters</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dsummary</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">dsummary</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>, <span class="va">cvs_clusters</span><span class="op">[[</span><span class="va">SD_ratio_i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">model</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">'CV crit'</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">+</span> <span class="va">clusters</span> <span class="op">~</span> <span class="va">model</span><span class="op">|</span><span class="va">SD_ratio_i</span>, <span class="va">dsummary</span>,</span>
<span>       auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'top'</span>, reverse.rows <span class="op">=</span> <span class="cn">T</span>, columns <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">'b'</span>,</span>
<span>       xlab <span class="op">=</span> <span class="st">"Fixed Effects"</span>,</span>
<span>       ylab <span class="op">=</span> <span class="st">'CV criterion (MSE)'</span>,</span>
<span>       layout<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">Nv</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>       par.settings <span class="op">=</span></span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>superpose.line<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>              superpose.symbol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pch <span class="op">=</span> <span class="fl">15</span><span class="op">:</span><span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       scales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alternating <span class="op">=</span> <span class="cn">F</span>, rot <span class="op">=</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig%2Fcross-validation-data-plot-1.png" alt="10-fold cluster- and case-based cross-validation comparing mixed models with random intercepts and various fixed effects." width="100%"><p class="caption">
10-fold cluster- and case-based cross-validation comparing mixed models
with random intercepts and various fixed effects.
</p>
</div>
<p>In summary, when between-cluster variance is relatively large, the
model <code>~ 1 + x</code>, with <code>x</code> alone and without the
contextual mean of <code>x</code>, is assessed as fitting very poorly by
cluster-based CV, but relatively much better by case-based CV. In all
our examples, the model <code>~ 1 + x + xm</code>, which includes both
<code>x</code> and its contextual mean, produces better results using
both cluster-based and case-based CV. These conclusions are consistent
with our observations based on graphing predictions from the various
models, and they illustrate the desirability of assessing mixed-effect
models at different hierarchical levels.</p>
</div>
<div class="section level2">
<h2 id="example-crossed-random-effects">Example: Crossed random effects<a class="anchor" aria-label="anchor" href="#example-crossed-random-effects"></a>
</h2>
<p>Crossed random effects arise when the structure of the data aren’t
strictly hierarchical. Nevertheless, crossed and nested random effects
can be handled in much the same manner, by refitting the mixed-effects
model to the data with a fold of clusters or cases removed and using the
refitted model to predict the response in the removed fold.</p>
<p>We’ll illustrate with data on pig growth, introduced by <span class="citation">Diggle, Liang, &amp; Zeger (1994, Table 3.1)</span>.
The data are in the <code>Pigs</code> data frame in the
<strong>cv</strong> package:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">Pigs</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id week weight</span></span>
<span><span class="co">#&gt; 1  1    1   24.0</span></span>
<span><span class="co">#&gt; 2  1    2   32.0</span></span>
<span><span class="co">#&gt; 3  1    3   39.0</span></span>
<span><span class="co">#&gt; 4  1    4   42.5</span></span>
<span><span class="co">#&gt; 5  1    5   48.0</span></span>
<span><span class="co">#&gt; 6  1    6   54.5</span></span>
<span><span class="co">#&gt; 7  1    7   61.0</span></span>
<span><span class="co">#&gt; 8  1    8   65.0</span></span>
<span><span class="co">#&gt; 9  1    9   72.0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/xtabs.html" class="external-link">xtabs</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">id</span> <span class="op">+</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;    week</span></span>
<span><span class="co">#&gt; id  1 2 3 4 5 6 7 8 9</span></span>
<span><span class="co">#&gt;   1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   2 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   3 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/xtabs.html" class="external-link">xtabs</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">id</span> <span class="op">+</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;     week</span></span>
<span><span class="co">#&gt; id   1 2 3 4 5 6 7 8 9</span></span>
<span><span class="co">#&gt;   46 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   47 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   48 1 1 1 1 1 1 1 1 1</span></span></code></pre></div>
<p>Each of 48 pigs is observed weekly over a period of 9 weeks, with the
weight of the pig recorded in kg. The data are in “long” format, as is
appropriate for use with the <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> function in the
<strong>lme4</strong> package. The data are very regular, with no
missing cases.</p>
<p>The following graph, showing the growth trajectories of the pigs, is
similar to Figure 3.1 in <span class="citation">Diggle et al.
(1994)</span>; we add an overall least-squares line and a loess smooth,
which are nearly indistinguishable:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span>, type <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">Pigs</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">Pigs</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">9</span>,</span>
<span>    y <span class="op">=</span> <span class="va">Pigs</span><span class="op">[</span><span class="va">id</span> <span class="op">==</span> <span class="va">i</span>, <span class="st">"weight"</span><span class="op">]</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"gray"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="va">week</span>, data <span class="op">=</span> <span class="va">Pigs</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>       lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">Pigs</span>, <span class="fu"><a href="https://rdrr.io/r/stats/scatter.smooth.html" class="external-link">loess.smooth</a></span><span class="op">(</span><span class="va">week</span>, <span class="va">weight</span>, span <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"magenta"</span>,</span>
<span>  lty <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  lwd <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="fig%2Fpigs-graph-1.png" alt="Growth trajectories for 48 pigs, with overall least-squares line (sold blue) and loess line (broken magenta)." width="60%"><p class="caption">
Growth trajectories for 48 pigs, with overall least-squares line (sold
blue) and loess line (broken magenta).
</p>
</div>
<p>The individual “growth curves” and the overall trend are generally
linear, with some tendency for variability of pig weight to increase
over weeks (a feature of the data that we ignore in the mixed model that
we fit to the data below).</p>
<p>The <strong>Stata</strong> mixed-effects models manual proposes a
model with crossed random effects for the <code>Pigs</code> data <span class="citation">(StataCorp LLC, 2023, p. 37)</span>:</p>
<blockquote>
<p>[S]uppose that we wish to fit
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow><mi mathvariant="normal">w</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">g</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">t</mi></mrow><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><msub><mrow><mi mathvariant="normal">w</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">k</mi></mrow><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><msub><mi>u</mi><mi>i</mi></msub><mo>+</mo><msub><mi>v</mi><mi>j</mi></msub><mo>+</mo><msub><mi>ε</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
\mathrm{weight}_{ij} = \beta_0 + \beta_1 \mathrm{week}_{ij} + u_i + v_j + \varepsilon_{ij} 
</annotation></semantics></math> for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">i = 1, \ldots, 9</annotation></semantics></math>
weeks and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mn>48</mn></mrow><annotation encoding="application/x-tex">j = 1, \dots, 48</annotation></semantics></math>
pigs and
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>u</mi><mi>i</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>σ</mi><mi>u</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mo>;</mo><msub><mi>v</mi><mi>j</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>σ</mi><mi>v</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mo>;</mo><msub><mi>ε</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>σ</mi><mi>ε</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
u_i \sim N(0, \sigma^2_u); v_j \sim N(0, \sigma^2_v ); \varepsilon_{ij} \sim N(0, \sigma^2_\varepsilon)
</annotation></semantics></math> all independently. That is, we assume
an overall population-average growth curve
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub><mrow><mi mathvariant="normal">w</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">k</mi></mrow></mrow><annotation encoding="application/x-tex">\beta_0 + \beta_1 \mathrm{week}</annotation></semantics></math>
and a random pig-specific shift. In other words, the effect due to week,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>u</mi><mi>i</mi></msub><annotation encoding="application/x-tex">u_i</annotation></semantics></math>,
is systematic to that week and common to all pigs. The rationale behind
[this model] could be that, assuming that the pigs were measured
contemporaneously, we might be concerned that week-specific random
factors such as weather and feeding patterns had significant systematic
effects on all pigs.</p>
</blockquote>
<p>Although we might prefer an alternative model,<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;These are repeated-measures data, which would be more
conventionally modeled with autocorrelated errors within pigs. The
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/nlme/man/lme.html" class="external-link"&gt;lme()&lt;/a&gt;&lt;/code&gt; function in the &lt;strong&gt;nlme&lt;/strong&gt; package, for
example, is capable of fitting a mixed-model of this form.&lt;/p&gt;'><sup>6</sup></a> we think that this is
a reasonable specification.</p>
<p>The <strong>Stata</strong> manual fits the mixed model by maximum
likelihood (rather than REML), and we duplicate the results reported
there using <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span></span>
<span>  <span class="va">weight</span> <span class="op">~</span> <span class="va">week</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">week</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">Pigs</span>,</span>
<span>  REML <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># i.e., ML</span></span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmerControl.html" class="external-link">lmerControl</a></span><span class="op">(</span>optimizer <span class="op">=</span> <span class="st">"bobyqa"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.p</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linear mixed model fit by maximum likelihood  ['lmerMod']</span></span>
<span><span class="co">#&gt; Formula: weight ~ week + (1 | id) + (1 | week)</span></span>
<span><span class="co">#&gt;    Data: Pigs</span></span>
<span><span class="co">#&gt; Control: lmerControl(optimizer = "bobyqa")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      AIC      BIC   logLik deviance df.resid </span></span>
<span><span class="co">#&gt;   2037.6   2058.0  -1013.8   2027.6      427 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals: </span></span>
<span><span class="co">#&gt;    Min     1Q Median     3Q    Max </span></span>
<span><span class="co">#&gt; -3.775 -0.542  0.005  0.476  3.982 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups   Name        Variance Std.Dev.</span></span>
<span><span class="co">#&gt;  id       (Intercept) 14.836   3.852   </span></span>
<span><span class="co">#&gt;  week     (Intercept)  0.085   0.292   </span></span>
<span><span class="co">#&gt;  Residual              4.297   2.073   </span></span>
<span><span class="co">#&gt; Number of obs: 432, groups:  id, 48; week, 9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value</span></span>
<span><span class="co">#&gt; (Intercept)  19.3556     0.6334    30.6</span></span>
<span><span class="co">#&gt; week          6.2099     0.0539   115.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correlation of Fixed Effects:</span></span>
<span><span class="co">#&gt;      (Intr)</span></span>
<span><span class="co">#&gt; week -0.426</span></span></code></pre></div>
<p>We opt for the non-default <code>"bobyqa"</code> optimizer because it
provides more numerically stable results for subsequent cross-validation
in this example.</p>
<p>We can then cross-validate the model by omitting folds composed of
pigs, folds composed of weeks, or folds composed of pig-weeks (which in
the <code>Pigs</code> data set correspond to individual cases, using
only the fixed effects):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">m.p</span>, clusterVariables <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; n-Fold Cross Validation based on 48 {id} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 19.973</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 19.965</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (17.125, 22.805)</span></span>
<span><span class="co">#&gt; full-sample criterion = 19.201</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">m.p</span>, clusterVariables <span class="op">=</span> <span class="st">"week"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; boundary (singular) fit: see help('isSingular')</span></span>
<span><span class="co">#&gt; n-Fold Cross Validation based on 9 {week} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 19.312</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 19.305</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (16.566, 22.044)</span></span>
<span><span class="co">#&gt; full-sample criterion = 19.201</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span></span>
<span>  <span class="va">m.p</span>,</span>
<span>  clusterVariables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"week"</span><span class="op">)</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">8469</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 8469</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation based on 432 {id, week} clusters</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 19.235</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 19.233</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (16.493, 21.973)</span></span>
<span><span class="co">#&gt; full-sample criterion = 19.201</span></span></code></pre></div>
<p>We can also cross-validate the individual cases taking account of the
random effects (employing the same 10 folds):</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/cv.html">cv</a></span><span class="op">(</span><span class="va">m.p</span>, k <span class="op">=</span> <span class="fl">10</span>, seed <span class="op">=</span> <span class="fl">8469</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; R RNG seed set to 8469</span></span>
<span><span class="co">#&gt; 10-Fold Cross Validation</span></span>
<span><span class="co">#&gt; criterion: mse</span></span>
<span><span class="co">#&gt; cross-validation criterion = 5.1583</span></span>
<span><span class="co">#&gt; bias-adjusted cross-validation criterion = 5.0729</span></span>
<span><span class="co">#&gt; 95% CI for bias-adjusted CV criterion = (4.123, 6.0229)</span></span>
<span><span class="co">#&gt; full-sample criterion = 3.796</span></span></code></pre></div>
<p>Because these predictions are based on BLUPs, they are more accurate
than the predictions based only on fixed effects.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Even though there is only one observation per
combination of pigs and weeks, we can use the BLUP for the omitted case
because of the crossed structure of the random effects; that is each
pig-week has a pig random effect and a week random effect. Although it
probably isn’t sensible, we can imagine a mixed model for the pig data
that employs nested random effects, which would be specified by
&lt;code&gt;lmer(weight ~ week + (1 | id/week), data=Pigs)&lt;/code&gt;—that is, a
random intercept that varies by combinations of &lt;code&gt;id&lt;/code&gt; (pig)
and &lt;code&gt;week&lt;/code&gt;. This model can’t be fit, however: With only one
case per combination of &lt;code&gt;id&lt;/code&gt; and &lt;code&gt;week&lt;/code&gt;, the
nested random-effect variance is indistinguishable from the case-level
variance.&lt;/p&gt;"><sup>7</sup></a> As well, the
difference between the MSE computed for the model fit to the full data
and the CV estimates of the MSE is greater here than for cluster-based
predictions.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-BatesEtAl:2015" class="csl-entry">
Bates, D., Mächler, M., Bolker, B., &amp; Walker, S. (2015). Fitting
linear mixed-effects models using <span class="nocase">lme4</span>.
<em>Journal of Statistical Software</em>, <em>67</em>(1), 1–48.
</div>
<div id="ref-BrooksEtAl:2017" class="csl-entry">
Brooks, M. E., Kristensen, K., van Benthem, K. J., Magnusson, A., Berg,
C. W., Nielsen, A., … Bolker, B. M. (2017). <span class="nocase">glmmTMB</span> balances speed and flexibility among
packages for zero-inflated generalized linear mixed modeling. <em>The R
Journal</em>, <em>9</em>(2), 378–400. http://doi.org/<a href="https://doi.org/10.32614/RJ-2017-066" class="external-link">10.32614/RJ-2017-066</a>
</div>
<div id="ref-DiggleLiangZeger:1994" class="csl-entry">
Diggle, P. J., Liang, K.-Y., &amp; Zeger, S. L. (1994). <em>Analysis of
longitudinal data</em>. Oxford: Oxford University Press.
</div>
<div id="ref-FoxWeisberg:2019" class="csl-entry">
Fox, J., &amp; Weisberg, S. (2019). <em>An <span>R</span> companion to
applied regression</em> (Third edition). Thousand Oaks <span>CA</span>:
Sage.
</div>
<div id="ref-PinheiroBates:2000" class="csl-entry">
Pinheiro, J. C., &amp; Bates, D. M. (2000). <em>Mixed-effects models in
<span>S</span> and <span>S-PLUS</span></em>. New York: Springer.
</div>
<div id="ref-RaudenbushBryk:2002" class="csl-entry">
Raudenbush, S. W., &amp; Bryk, A. S. (2002). <em>Hierarchical linear
models: Applications and data analysis methods</em> (Second edition).
Thousand Oaks <span>CA</span>: Sage.
</div>
<div id="ref-Sarkar:2008" class="csl-entry">
Sarkar, D. (2008). <em>Lattice: Multivariate data visualization with
<span>R</span></em>. New York: Springer. Retrieved from <a href="http://lmdvr.r-forge.r-project.org" class="external-link">http://lmdvr.r-forge.r-project.org</a>
</div>
<div id="ref-SarkarAndrews:2022" class="csl-entry">
Sarkar, D., &amp; Andrews, F. (2022). <em><span class="nocase">latticeExtra</span>: Extra graphical utilities based on
<span class="nocase">lattice</span></em>. Retrieved from <a href="https://CRAN.R-project.org/package=latticeExtra" class="external-link">https://CRAN.R-project.org/package=latticeExtra</a>
</div>
<div id="ref-Stata:2023" class="csl-entry">
StataCorp LLC. (2023). <em>Stata multilevel mixed-effects reference
manual, release 18</em>. College Station <span>TX</span>: Stata Press.
Retrieved from <a href="https://www.stata.com/manuals/me.pdf" class="external-link">https://www.stata.com/manuals/me.pdf</a>
</div>
<div id="ref-Vehtari:2023" class="csl-entry">
Vehtari, A. (2023). Cross-validation <span>FAQ</span>. Retrieved October
15, 2023, from <a href="https://users.aalto.fi/~ave/CV-FAQ.html" class="external-link">https://users.aalto.fi/~ave/CV-FAQ.html</a>
</div>
<div id="ref-WickhamEtAl:2023" class="csl-entry">
Wickham, H., François, R., Henry, L., Müller, K., &amp; Vaughan, D.
(2023). <em>Dplyr: A grammar of data manipulation</em>. Retrieved from
<a href="https://CRAN.R-project.org/package=dplyr" class="external-link">https://CRAN.R-project.org/package=dplyr</a>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Fox, Georges Monette.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
